<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„ AI å›¢é˜Ÿ - çµçŠ€äº‘</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0f;
      min-height: 100vh;
      color: #fff;
    }
    
    .navbar {
      background: rgba(20, 20, 30, 0.95);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav-left { display: flex; align-items: center; gap: 15px; }
    .logo {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #00d4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .user-info { font-size: 14px; color: rgba(255,255,255,0.7); }
    .user-name { color: #00d4ff; font-weight: 500; }
    .nav-right { display: flex; align-items: center; gap: 10px; }
    .nav-btn {
      padding: 8px 16px;
      font-size: 13px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
      color: rgba(255,255,255,0.8);
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    .nav-btn:hover { background: rgba(255,255,255,0.1); }
    .nav-btn.primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      color: #fff;
    }
    
    .main { padding: 20px; max-width: 1200px; margin: 0 auto; }
    
    /* æ¬¢è¿åŒº */
    .welcome-card {
      background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(0,212,255,0.05));
      border: 1px solid rgba(102,126,234,0.2);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
      text-align: center;
    }
    .welcome-title { font-size: 28px; font-weight: 700; margin-bottom: 10px; }
    .welcome-desc { color: rgba(255,255,255,0.6); margin-bottom: 20px; }
    
    /* å¼€å§‹èŠå¤©æŒ‰é’® */
    .start-chat-btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 16px 40px;
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 50px;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s;
    }
    .start-chat-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 10px 30px rgba(102,126,234,0.4);
    }
    
    /* å›¢é˜Ÿå±•ç¤º */
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: rgba(255,255,255,0.9);
    }
    .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .team-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .team-emoji { font-size: 32px; }
    .team-info { flex: 1; }
    .team-name { font-size: 16px; font-weight: 600; }
    .team-role { font-size: 12px; color: rgba(255,255,255,0.5); }
    
    /* é›†æˆçŠ¶æ€ */
    .integration-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .integration-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
    }
    .integration-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .integration-title { font-size: 16px; font-weight: 600; }
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
    }
    .status-badge.active { background: rgba(16,185,129,0.2); color: #10b981; }
    .status-badge.inactive { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }
    .integration-desc { font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 15px; }
    .setup-btn {
      padding: 8px 16px;
      font-size: 13px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .setup-btn:hover { background: rgba(255,255,255,0.2); }
    
    /* ä¸ªäººä¸­å¿ƒå¼¹çª— */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal {
      background: linear-gradient(135deg, rgba(20,20,30,0.98), rgba(10,10,15,0.99));
      border: 1px solid rgba(102,126,234,0.3);
      border-radius: 16px;
      padding: 30px;
      width: 90%;
      max-width: 400px;
    }
    .modal-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #667eea, #00d4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .form-group { margin-bottom: 15px; }
    .form-group label {
      display: block;
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 6px;
    }
    .form-group input {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      color: #fff;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      outline: none;
    }
    .form-group input:focus { border-color: rgba(102,126,234,0.5); }
    .form-btn {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
    .form-btn:disabled { background: #333; cursor: not-allowed; }
    .form-error { color: #ef4444; font-size: 12px; margin-top: 10px; }
    .form-success { color: #10b981; font-size: 12px; margin-top: 10px; }
    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: rgba(255,255,255,0.5);
      font-size: 24px;
      cursor: pointer;
    }
    
    /* è€ç”¨æˆ·è®¾ç½®å¯†ç æç¤º */
    .alert-banner {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 12px;
      padding: 15px 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .alert-text { font-size: 14px; color: rgba(255,255,255,0.8); }
    .alert-btn {
      padding: 8px 16px;
      font-size: 13px;
      background: rgba(245, 158, 11, 0.2);
      border: none;
      color: #f59e0b;
      border-radius: 6px;
      cursor: pointer;
    }
    .hidden { display: none !important; }
    
    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      .nav-right .nav-btn:not(.primary) { display: none; }
      .team-grid { grid-template-columns: repeat(2, 1fr); }
      .integration-cards { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- å¯¼èˆªæ  -->
  <nav class="navbar">
    <div class="nav-left">
      <div class="logo">âš¡ çµçŠ€äº‘</div>
      <div class="user-info">æ¬¢è¿ï¼Œ<span class="user-name" id="userName">ç”¨æˆ·</span></div>
    </div>
    <div class="nav-right">
      <a href="/" class="nav-btn">é¦–é¡µ</a>
      <button class="nav-btn" onclick="modifyTeam()">ä¿®æ”¹å›¢é˜Ÿ</button>
      <button class="nav-btn primary" onclick="showProfile()">âš™ï¸ ä¸ªäººä¸­å¿ƒ</button>
    </div>
  </nav>

  <div class="main">
    <!-- è€ç”¨æˆ·è®¾ç½®å¯†ç æç¤º -->
    <div class="alert-banner hidden" id="passwordAlert">
      <span class="alert-text">âš ï¸ ä¸ºä¿æŠ¤è´¦å·å®‰å…¨ï¼Œè¯·è®¾ç½®ç™»å½•å¯†ç </span>
      <button class="alert-btn" onclick="showProfile()">ç«‹å³è®¾ç½®</button>
    </div>

    <!-- æ¬¢è¿åŒº -->
    <div class="welcome-card">
      <h1 class="welcome-title">ä½ çš„ AI å›¢é˜Ÿå·²å°±ç»ªï¼</h1>
      <p class="welcome-desc" id="teamDesc">å›¢é˜Ÿæˆå‘˜ï¼šçµçŠ€ + äº‘æºª + è‹¥æ›¦</p>
      <a id="chatLink" class="start-chat-btn" target="_blank">
        ğŸ’¬ å¼€å§‹å¯¹è¯
      </a>
    </div>

    <!-- æˆ‘çš„å›¢é˜Ÿ -->
    <h2 class="section-title">æˆ‘çš„å›¢é˜Ÿ</h2>
    <div class="team-grid" id="teamGrid"></div>

    <!-- é›†æˆçŠ¶æ€ -->
    <h2 class="section-title">å¹³å°æ¥å…¥</h2>
    <div class="integration-cards">
      <div class="integration-card">
        <div class="integration-header">
          <span class="integration-title">ğŸ“± é£ä¹¦</span>
          <span class="status-badge inactive" id="feishuBadge">æœªé…ç½®</span>
        </div>
        <p class="integration-desc">æ¥å…¥é£ä¹¦åï¼Œå¯åœ¨é£ä¹¦ä¸­ç›´æ¥ä¸ AI å›¢é˜Ÿå¯¹è¯</p>
        <button class="setup-btn" onclick="setupFeishu()">é…ç½®é£ä¹¦</button>
      </div>
      <div class="integration-card">
        <div class="integration-header">
          <span class="integration-title">ğŸ’¼ ä¼ä¸šå¾®ä¿¡</span>
          <span class="status-badge inactive" id="wecomBadge">æœªé…ç½®</span>
        </div>
        <p class="integration-desc">æ¥å…¥ä¼ä¸šå¾®ä¿¡åï¼Œå¯åœ¨ä¼å¾®ä¸­ç›´æ¥ä¸ AI å›¢é˜Ÿå¯¹è¯</p>
        <button class="setup-btn" onclick="setupWeCom()">é…ç½®ä¼ä¸šå¾®ä¿¡</button>
      </div>
    </div>
  </div>

  <!-- ä¸ªäººä¸­å¿ƒå¼¹çª— -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal" style="position: relative;">
      <button class="modal-close" onclick="closeProfile()">&times;</button>
      <h2 class="modal-title">âš™ï¸ ä¸ªäººä¸­å¿ƒ</h2>
      
      <div class="form-group">
        <label>æ˜µç§°</label>
        <input type="text" id="profileNickname" placeholder="ä½ çš„æ˜µç§°">
      </div>
      
      <div id="passwordSection">
        <div class="form-group">
          <label>è®¾ç½®æ–°å¯†ç </label>
          <input type="password" id="newPassword" placeholder="è‡³å°‘6ä½" minlength="6">
        </div>
        <div class="form-group">
          <label>ç¡®è®¤å¯†ç </label>
          <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥">
        </div>
      </div>
      
      <button class="form-btn" onclick="saveProfile()">ä¿å­˜</button>
      <div class="form-error hidden" id="profileError"></div>
      <div class="form-success hidden" id="profileSuccess"></div>
      
      <button class="form-btn" style="background: #333; margin-top: 20px;" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <!-- é£ä¹¦é…ç½®å¼¹çª— -->
  <div class="modal-overlay" id="feishuModal">
    <div class="modal" style="position: relative;">
      <button class="modal-close" onclick="closeFeishu()">&times;</button>
      <h2 class="modal-title">ğŸ“± é…ç½®é£ä¹¦</h2>
      <p style="font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 20px;">
        åœ¨é£ä¹¦å¼€æ”¾å¹³å°åˆ›å»ºåº”ç”¨ï¼Œå¡«å…¥ä»¥ä¸‹å‡­è¯
      </p>
      <div class="form-group">
        <label>App ID</label>
        <input type="text" id="feishuAppId" placeholder="cli_xxx">
      </div>
      <div class="form-group">
        <label>App Secret</label>
        <input type="text" id="feishuAppSecret" placeholder="xxx">
      </div>
      <button class="form-btn" onclick="saveFeishu()">ä¿å­˜é…ç½®</button>
      <div class="form-error hidden" id="feishuError"></div>
      <div class="form-success hidden" id="feishuSuccess"></div>
    </div>
  </div>

  <!-- ä¼å¾®é…ç½®å¼¹çª— -->
  <div class="modal-overlay" id="wecomModal">
    <div class="modal" style="position: relative;">
      <button class="modal-close" onclick="closeWeCom()">&times;</button>
      <h2 class="modal-title">ğŸ’¼ é…ç½®ä¼ä¸šå¾®ä¿¡</h2>
      <p style="font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 20px;">
        åœ¨ä¼ä¸šå¾®ä¿¡ç®¡ç†åå°åˆ›å»ºåº”ç”¨ï¼Œå¡«å…¥ä»¥ä¸‹å‡­è¯
      </p>
      <div class="form-group">
        <label>Corp ID</label>
        <input type="text" id="wecomCorpId" placeholder="ä¼ä¸šID">
      </div>
      <div class="form-group">
        <label>Agent ID</label>
        <input type="text" id="wecomAgentId" placeholder="åº”ç”¨ID">
      </div>
      <div class="form-group">
        <label>Secret</label>
        <input type="text" id="wecomSecret" placeholder="åº”ç”¨Secret">
      </div>
      <button class="form-btn" onclick="saveWeCom()">ä¿å­˜é…ç½®</button>
      <div class="form-error hidden" id="wecomError"></div>
      <div class="form-success hidden" id="wecomSuccess"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000';
    const OPENCLAW_URL = 'http://120.26.137.51:18789/c308f1f0?token=6f3719a52fa12799fea8e4a06655703f';
    
    const AGENT_INFO = {
      lingxi: { emoji: 'âš¡', name: 'çµçŠ€', role: 'é˜Ÿé•¿ Â· æ™ºèƒ½è°ƒåº¦' },
      coder: { emoji: 'ğŸ’»', name: 'äº‘æºª', role: 'ä»£ç å¥³ç‹' },
      ops: { emoji: 'ğŸ“Š', name: 'è‹¥æ›¦', role: 'è¿è¥ä¸“å®¶' },
      inventor: { emoji: 'ğŸ’¡', name: 'ç´«è±', role: 'åˆ›æ„å¤©æ‰' },
      pm: { emoji: 'ğŸ¯', name: 'æ¢“è±', role: 'äº§å“å¥³ç‹' },
      noter: { emoji: 'ğŸ“', name: 'æ™“ç³', role: 'çŸ¥è¯†ç®¡ç†' },
      media: { emoji: 'ğŸ§', name: 'éŸ³éŸµ', role: 'å¤šåª’ä½“' },
      smart: { emoji: 'ğŸ ', name: 'æ™ºå®¶', role: 'æ™ºèƒ½å®¶å±…' }
    };
    
    let user = null;
    let token = localStorage.getItem('lingxi_token');
    
    // åˆå§‹åŒ–
    async function init() {
      // æ£€æŸ¥ç™»å½•
      if (!token) {
        window.location.href = 'index.html';
        return;
      }
      
      // åŠ è½½ç”¨æˆ·ä¿¡æ¯
      await loadUser();
      
      // æ£€æŸ¥æ˜¯å¦æœ‰å¯†ç 
      if (user && !user.hasPassword) {
        document.getElementById('passwordAlert').classList.remove('hidden');
      }
      
      // æ¸²æŸ“å›¢é˜Ÿ
      renderTeam();
      
      // è®¾ç½®èŠå¤©é“¾æ¥
      document.getElementById('chatLink').href = OPENCLAW_URL;
      
      // æ£€æŸ¥é›†æˆçŠ¶æ€
      checkIntegrations();
    }
    
    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    async function loadUser() {
      try {
        const userStr = localStorage.getItem('lingxi_user');
        user = userStr ? JSON.parse(userStr) : null;
        
        // ä» API è·å–æœ€æ–°ä¿¡æ¯
        const res = await fetch(`${API_BASE}/api/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (res.ok) {
          const data = await res.json();
          user = { ...user, ...data };
          localStorage.setItem('lingxi_user', JSON.stringify(user));
        }
      } catch (e) {
        console.log('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
      }
      
      if (user) {
        document.getElementById('userName').textContent = user.nickname || 'ç”¨æˆ·';
        document.getElementById('profileNickname').value = user.nickname || '';
      }
    }
    
    // æ¸²æŸ“å›¢é˜Ÿ
    function renderTeam() {
      const agents = user?.agents || ['lingxi'];
      const grid = document.getElementById('teamGrid');
      
      grid.innerHTML = agents.map(id => {
        const agent = AGENT_INFO[id] || { emoji: 'ğŸ¤–', name: id, role: 'åŠ©æ‰‹' };
        return `
          <div class="team-card">
            <div class="team-emoji">${agent.emoji}</div>
            <div class="team-info">
              <div class="team-name">${agent.name}</div>
              <div class="team-role">${agent.role}</div>
            </div>
          </div>
        `;
      }).join('');
      
      // æ›´æ–°å›¢é˜Ÿæè¿°
      const names = agents.map(id => AGENT_INFO[id]?.name || id);
      document.getElementById('teamDesc').textContent = `å›¢é˜Ÿæˆå‘˜ï¼š${names.join(' + ')}`;
    }
    
    // æ£€æŸ¥é›†æˆçŠ¶æ€
    async function checkIntegrations() {
      if (!user?.id) return;
      
      try {
        // é£ä¹¦
        const feishuRes = await fetch(`${API_BASE}/api/feishu/status/${user.id}`);
        const feishuData = await feishuRes.json();
        if (feishuData.configured) {
          document.getElementById('feishuBadge').textContent = 'å·²é…ç½®';
          document.getElementById('feishuBadge').classList.replace('inactive', 'active');
        }
        
        // ä¼å¾®
        const wecomRes = await fetch(`${API_BASE}/api/wecom/status/${user.id}`);
        const wecomData = await wecomRes.json();
        if (wecomData.configured) {
          document.getElementById('wecomBadge').textContent = 'å·²é…ç½®';
          document.getElementById('wecomBadge').classList.replace('inactive', 'active');
        }
      } catch (e) {
        console.log('æ£€æŸ¥é›†æˆçŠ¶æ€å¤±è´¥:', e);
      }
    }
    
    // ä¿®æ”¹å›¢é˜Ÿ
    function modifyTeam() {
      window.location.href = 'team.html';
    }
    
    // ä¸ªäººä¸­å¿ƒ
    function showProfile() {
      document.getElementById('profileModal').classList.add('active');
    }
    
    function closeProfile() {
      document.getElementById('profileModal').classList.remove('active');
    }
    
    async function saveProfile() {
      const nickname = document.getElementById('profileNickname').value.trim();
      const password = document.getElementById('newPassword').value;
      const confirm = document.getElementById('confirmPassword').value;
      const errorEl = document.getElementById('profileError');
      const successEl = document.getElementById('profileSuccess');
      
      errorEl.classList.add('hidden');
      successEl.classList.add('hidden');
      
      if (password && password.length < 6) {
        errorEl.textContent = 'å¯†ç è‡³å°‘6ä½';
        errorEl.classList.remove('hidden');
        return;
      }
      
      if (password && password !== confirm) {
        errorEl.textContent = 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´';
        errorEl.classList.remove('hidden');
        return;
      }
      
      // TODO: è°ƒç”¨ API ä¿å­˜
      user.nickname = nickname;
      if (password) user.hasPassword = true;
      localStorage.setItem('lingxi_user', JSON.stringify(user));
      
      document.getElementById('userName').textContent = nickname || 'ç”¨æˆ·';
      document.getElementById('passwordAlert').classList.add('hidden');
      
      successEl.textContent = 'ä¿å­˜æˆåŠŸï¼';
      successEl.classList.remove('hidden');
    }
    
    // é£ä¹¦é…ç½®
    function setupFeishu() {
      document.getElementById('feishuModal').classList.add('active');
    }
    
    function closeFeishu() {
      document.getElementById('feishuModal').classList.remove('active');
    }
    
    async function saveFeishu() {
      const appId = document.getElementById('feishuAppId').value.trim();
      const appSecret = document.getElementById('feishuAppSecret').value.trim();
      const errorEl = document.getElementById('feishuError');
      const successEl = document.getElementById('feishuSuccess');
      
      errorEl.classList.add('hidden');
      successEl.classList.add('hidden');
      
      if (!appId || !appSecret) {
        errorEl.textContent = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
        errorEl.classList.remove('hidden');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/api/feishu/configure`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: user.id, appId, appSecret })
        });
        
        const data = await res.json();
        
        if (data.success) {
          successEl.innerHTML = `âœ… é…ç½®æˆåŠŸï¼<br><small>å›è°ƒåœ°å€ï¼š${data.config.webhookUrl}</small>`;
          successEl.classList.remove('hidden');
          document.getElementById('feishuBadge').textContent = 'å·²é…ç½®';
          document.getElementById('feishuBadge').classList.replace('inactive', 'active');
        } else {
          errorEl.textContent = data.error || 'é…ç½®å¤±è´¥';
          errorEl.classList.remove('hidden');
        }
      } catch (e) {
        errorEl.textContent = 'ç½‘ç»œé”™è¯¯';
        errorEl.classList.remove('hidden');
      }
    }
    
    // ä¼å¾®é…ç½®
    function setupWeCom() {
      document.getElementById('wecomModal').classList.add('active');
    }
    
    function closeWeCom() {
      document.getElementById('wecomModal').classList.remove('active');
    }
    
    async function saveWeCom() {
      const corpId = document.getElementById('wecomCorpId').value.trim();
      const agentId = document.getElementById('wecomAgentId').value.trim();
      const secret = document.getElementById('wecomSecret').value.trim();
      const errorEl = document.getElementById('wecomError');
      const successEl = document.getElementById('wecomSuccess');
      
      errorEl.classList.add('hidden');
      successEl.classList.add('hidden');
      
      if (!corpId || !agentId || !secret) {
        errorEl.textContent = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
        errorEl.classList.remove('hidden');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/api/wecom/configure`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: user.id, corpId, agentId, secret })
        });
        
        const data = await res.json();
        
        if (data.success) {
          successEl.innerHTML = `âœ… é…ç½®æˆåŠŸï¼<br><small>å›è°ƒåœ°å€ï¼š${data.config.callbackUrl}</small>`;
          successEl.classList.remove('hidden');
          document.getElementById('wecomBadge').textContent = 'å·²é…ç½®';
          document.getElementById('wecomBadge').classList.replace('inactive', 'active');
        } else {
          errorEl.textContent = data.error || 'é…ç½®å¤±è´¥';
          errorEl.classList.remove('hidden');
        }
      } catch (e) {
        errorEl.textContent = 'ç½‘ç»œé”™è¯¯';
        errorEl.classList.remove('hidden');
      }
    }
    
    // é€€å‡ºç™»å½•
    function logout() {
      localStorage.removeItem('lingxi_token');
      localStorage.removeItem('lingxi_user');
      window.location.href = 'index.html';
    }
    
    // å¯åŠ¨
    init();
  </script>
</body>
</html>
