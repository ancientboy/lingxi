<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çµçŠ€äº‘ - AI å›¢é˜Ÿ</title>
  <link rel="stylesheet" href="assets/css/chat.css">
  <link rel="stylesheet" href="assets/css/dark.css" id="darkTheme" disabled>
  <!-- Lucide Icons - ä½¿ç”¨ cdnjs å¤‡ç”¨æº -->
  <script src="assets/libs/lucide.min.js"></script>
  <style>
    /* å›¾æ ‡ç»Ÿä¸€æ ·å¼ */
    .icon { width: 20px; height: 20px; color: currentColor; }
    .icon-sm { width: 16px; height: 16px; }
    .icon-lg { width: 24px; height: 24px; }
    .icon-primary { color: #10a37f; }
  </style>
</head>
<body>
  <!-- ä¾§è¾¹æ  -->
  <aside class="sidebar" id="sidebar">
    <a href="index.html" class="sidebar-brand">
      <div class="sidebar-brand-icon">
        <i data-lucide="sparkles" class="icon-lg"></i>
      </div>
      <span class="sidebar-brand-name">Lume</span>
    </a>
    <div class="sidebar-header">
      <button class="sidebar-new-chat" onclick="newChat()">
        <i data-lucide="plus" class="icon-sm"></i>
        <span>æ–°å¯¹è¯</span>
      </button>
      <button class="sidebar-close" onclick="toggleSidebar()">
        <i data-lucide="x" class="icon-sm"></i>
      </button>
    </div>
    
    <div class="sidebar-content">
      <div class="sidebar-section">
        <div class="sidebar-section-title">ä»Šå¤©</div>
        <div class="sidebar-sessions" id="todaySessions"></div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-section-title">æœ€è¿‘7å¤©</div>
        <div class="sidebar-sessions" id="weekSessions"></div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-section-title">æ›´æ—©</div>
        <div class="sidebar-sessions" id="olderSessions"></div>
      </div>
    </div>
    
    <!-- åŠŸèƒ½åŒºï¼ˆä¸­é—´ï¼‰ -->
    <div class="sidebar-tools">
      <div class="sidebar-tool-item" onclick="showMyTeam()">
        <i data-lucide="users" class="icon-sm icon-primary"></i>
        <span>æˆ‘çš„å›¢é˜Ÿ</span>
      </div>
      <div class="sidebar-tool-item" onclick="showFeishuConfig()">
        <i data-lucide="message-square" class="icon-sm icon-primary"></i>
        <span>é£ä¹¦é…ç½®</span>
      </div>
      <div class="sidebar-tool-item" onclick="showWecomConfig()">
        <i data-lucide="briefcase" class="icon-sm icon-primary"></i>
        <span>ä¼ä¸šå¾®ä¿¡</span>
      </div>
    </div>
    
    <!-- åº•éƒ¨ç”¨æˆ·åŒº -->
    <div class="sidebar-footer">
      <div class="sidebar-user-trigger" onclick="toggleUserMenu()">
        <div class="sidebar-user-avatar" id="sidebarUserAvatar">U</div>
        <span class="sidebar-user-name" id="sidebarUserName">ç”¨æˆ·</span>
        <span class="sidebar-user-arrow">â–¼</span>
      </div>
      <!-- ç”¨æˆ·ä¸‹æ‹‰èœå• -->
      <div class="sidebar-user-menu" id="sidebarUserMenu">
        <div class="sidebar-menu-item" onclick="showPasswordChange()">
          <i data-lucide="lock" class="icon-sm"></i>
          <span>ä¿®æ”¹å¯†ç </span>
        </div>
        <div class="sidebar-menu-item" onclick="showAbout()">
          <i data-lucide="info" class="icon-sm"></i>
          <span>å…³äº</span>
        </div>
        <div class="sidebar-divider"></div>
        <div class="sidebar-menu-item danger" onclick="logout()">
          <i data-lucide="log-out" class="icon-sm"></i>
          <span>é€€å‡ºç™»å½•</span>
        </div>
      </div>
    </div>
  </aside>

  <!-- ä¾§è¾¹æ é®ç½©ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- ä¾§è¾¹æ æ‹–æ‹½è°ƒæ•´å™¨ -->
  <div class="sidebar-resizer" id="sidebarResizer"></div>

  <!-- ä¸»å†…å®¹åŒº -->
  <main class="main-content" id="mainContent">
    <nav class="navbar">
      <div class="nav-left">
        <button class="sidebar-toggle" onclick="toggleSidebar()" title="åˆ‡æ¢ä¾§è¾¹æ ">
          <i data-lucide="menu" class="icon"></i>
        </button>
        <a href="index.html" class="logo">Lume</a>
        <div class="status-dot" id="connectionStatus" title="å·²è¿æ¥"></div>
      </div>
      <div class="nav-right">
        <div class="agent-switcher" onclick="toggleAgentDropdown()" title="åˆ‡æ¢ Agent">
          <i data-lucide="zap" class="icon icon-primary" id="currentAgentIcon"></i>
          <span class="agent-switcher-arrow">â–¼</span>
          <div class="agent-dropdown" id="agentDropdown"></div>
        </div>
        <!-- ç­¾åˆ°æŒ‰é’® -->
        <div class="checkin-btn" id="checkinBtn" onclick="handleCheckin()" title="æ¯æ—¥ç­¾åˆ°">
          <i data-lucide="calendar" class="icon-sm"></i>
          <span class="checkin-text" id="checkinText">ç­¾åˆ°</span>
          <span class="checkin-points" id="checkinPoints"></span>
        </div>
        <!-- ä¸»é¢˜åˆ‡æ¢ -->
        <button class="theme-toggle-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
          <i data-lucide="moon" class="icon" id="themeToggleIcon"></i>
        </button>
      </div>
    </nav>

    <!-- å›¢é˜Ÿç®¡ç†å¼¹çª— -->
    <div class="modal-overlay" id="teamModal">
      <div class="modal team-modal">
        <div class="modal-header">
          <h3><i data-lucide="users" class="icon-sm icon-primary"></i> æˆ‘çš„å›¢é˜Ÿ</h3>
          <button class="close-btn" onclick="closeTeamModal()">
            <i data-lucide="x" class="icon-sm"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="team-list" id="myTeamList"></div>
          <div class="add-team-section">
            <h4>æ·»åŠ æˆå‘˜</h4>
            <div class="available-agents" id="availableAgents"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- é£ä¹¦é…ç½®å¼¹çª— -->
    <div class="modal-overlay" id="feishuModal">
      <div class="modal">
        <div class="modal-header">
          <h3><i data-lucide="message-square" class="icon-sm icon-primary"></i> é£ä¹¦é…ç½®</h3>
          <button class="close-btn" onclick="closeFeishuModal()">
            <i data-lucide="x" class="icon-sm"></i>
          </button>
        </div>
        <div class="modal-body">
          <div id="feishuStatus" style="margin-bottom:16px;"></div>
          <form id="feishuForm" onsubmit="saveFeishuConfig(event)">
            <div class="form-group">
              <label>App ID</label>
              <input type="text" id="feishuAppId" placeholder="cli_xxxxxxxxxxxx" autocomplete="off">
            </div>
            <div class="form-group">
              <label>App Secret</label>
              <input type="password" id="feishuAppSecret" placeholder="åº”ç”¨å¯†é’¥" autocomplete="off">
            </div>
            <button type="submit" class="submit-btn">ä¿å­˜é…ç½®</button>
          </form>
          <div id="feishuWebhook" style="margin-top:16px;display:none;">
            <label style="font-size:12px;color:#6e6e80;">Webhook åœ°å€ï¼ˆå¤åˆ¶åˆ°é£ä¹¦å¼€æ”¾å¹³å°ï¼‰</label>
            <div style="display:flex;gap:8px;margin-top:6px;">
              <input type="text" id="feishuWebhookUrl" readonly style="flex:1;font-size:12px;">
              <button type="button" class="nav-btn" onclick="copyFeishuWebhook()">å¤åˆ¶</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¼ä¸šå¾®ä¿¡é…ç½®å¼¹çª— -->
    <div class="modal-overlay" id="wecomModal">
      <div class="modal">
        <div class="modal-header">
          <h3><i data-lucide="briefcase" class="icon-sm icon-primary"></i> ä¼ä¸šå¾®ä¿¡é…ç½®</h3>
          <button class="close-btn" onclick="closeWecomModal()">
            <i data-lucide="x" class="icon-sm"></i>
          </button>
        </div>
        <div class="modal-body">
          <div id="wecomStatus" style="margin-bottom:16px;"></div>
          <form id="wecomForm" onsubmit="saveWecomConfig(event)">
            <div class="form-group">
              <label>ä¼ä¸š ID (Corp ID)</label>
              <input type="text" id="wecomCorpId" placeholder="wwxxxxxxxxxxxxxx" autocomplete="off">
            </div>
            <div class="form-group">
              <label>Agent ID</label>
              <input type="text" id="wecomAgentId" placeholder="1000001" autocomplete="off">
            </div>
            <div class="form-group">
              <label>Agent Secret</label>
              <input type="password" id="wecomAgentSecret" placeholder="åº”ç”¨å¯†é’¥" autocomplete="off">
            </div>
            <button type="submit" class="submit-btn">ä¿å­˜é…ç½®</button>
          </form>
          <div id="wecomWebhook" style="margin-top:16px;display:none;">
            <label style="font-size:12px;color:#6e6e80;">å›è°ƒåœ°å€</label>
            <div style="display:flex;gap:8px;margin-top:6px;">
              <input type="text" id="wecomWebhookUrl" readonly style="flex:1;font-size:12px;">
              <button type="button" class="nav-btn" onclick="copyWecomWebhook()">å¤åˆ¶</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç å¼¹çª— -->
    <div class="modal-overlay" id="passwordModal">
      <div class="modal">
        <div class="modal-header">
          <h3><i data-lucide="lock" class="icon-sm icon-primary"></i> ä¿®æ”¹å¯†ç </h3>
          <button class="close-btn" onclick="closePasswordModal()">
            <i data-lucide="x" class="icon-sm"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="passwordForm" onsubmit="changePassword(event)">
            <div class="form-group">
              <label>å½“å‰å¯†ç </label>
              <input type="password" id="currentPassword" placeholder="è¾“å…¥å½“å‰å¯†ç " required>
            </div>
            <div class="form-group">
              <label>æ–°å¯†ç </label>
              <input type="password" id="newPassword" placeholder="è‡³å°‘6ä½" required minlength="6">
            </div>
            <div class="form-group">
              <label>ç¡®è®¤æ–°å¯†ç </label>
              <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " required>
            </div>
            <button type="submit" class="submit-btn">ä¿®æ”¹å¯†ç </button>
          </form>
        </div>
      </div>
    </div>

    <!-- æ–°ç”¨æˆ·å¼•å¯¼å¼¹çª— -->
    <div class="modal-overlay" id="onboardingModal" style="display:none;">
      <div class="modal onboarding-modal" style="max-width:480px;">
        <!-- Step 1: æ¬¢è¿ -->
        <div id="onboardingStep1" class="onboarding-step">
          <div class="onboarding-welcome">
            <div class="onboarding-icon">
              <i data-lucide="zap" class="icon-lg"></i>
            </div>
            <h2>ä½ å¥½ï¼æˆ‘æ˜¯çµçŠ€</h2>
            <p>ä½ çš„ AI å›¢é˜Ÿé˜Ÿé•¿ï¼Œæ¥è‡ªæ˜Ÿé™…çš„æ™ºèƒ½åŠ©æ‰‹</p>
            <p style="font-size:14px;color:#6e6e80;margin-top:16px;">
              çœ‹èµ·æ¥ä½ æ˜¯ç¬¬ä¸€æ¬¡æ¥ï¼Œè®©æˆ‘å…ˆäº†è§£ä¸€ä¸‹ä½ ï½
            </p>
          </div>
          <button class="home-btn" onclick="goToOnboardingStep(2)" style="margin-top:24px;">
            å¼€å§‹äº†è§£
          </button>
        </div>
        
        <!-- Step 2: é€‰æ‹©èŒä¸š -->
        <div id="onboardingStep2" class="onboarding-step" style="display:none;">
          <h3 style="text-align:center;margin-bottom:20px;">è¯·é—®ä½ ä¸»è¦æ˜¯åšä»€ä¹ˆå·¥ä½œçš„ï¼Ÿ</h3>
          <div class="job-type-grid" id="jobTypeGrid"></div>
        </div>
        
        <!-- Step 3: æ¨èé…ç½® -->
        <div id="onboardingStep3" class="onboarding-step" style="display:none;">
          <h3 style="text-align:center;margin-bottom:8px;">æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œæˆ‘å»ºè®®é…ç½®</h3>
          <p id="recommendationHint" style="text-align:center;font-size:13px;color:#6e6e80;margin-bottom:20px;"></p>
          
          <div class="recommendation-agents" id="recommendationAgents"></div>
          
          <div style="margin-top:24px;display:flex;gap:12px;">
            <button class="home-btn home-btn-secondary" onclick="goToOnboardingStep(2)" style="flex:1;">
              é‡æ–°é€‰æ‹©
            </button>
            <button class="home-btn" onclick="applyRecommendation()" id="applyRecommendationBtn" style="flex:1;">
              åº”ç”¨é…ç½®
            </button>
          </div>
        </div>
        
        <!-- Step 4: å®Œæˆ -->
        <div id="onboardingStep4" class="onboarding-step" style="display:none;">
          <div class="onboarding-complete">
            <div class="onboarding-icon" style="background:#10a37f;">
              <i data-lucide="check" class="icon-lg"></i>
            </div>
            <h2>ğŸ‰ é…ç½®å®Œæˆï¼</h2>
            <p>ä½ çš„ AI å›¢é˜Ÿå·²å°±ç»ªï¼Œç°åœ¨å¯ä»¥å¼€å§‹å¯¹è¯äº†</p>
            <div class="team-preview" id="teamPreview"></div>
          </div>
          <button class="home-btn" onclick="startChat()" style="margin-top:24px;">
            å¼€å§‹å¯¹è¯
          </button>
        </div>
      </div>
    </div>

    <style>
      /* å¼•å¯¼å¼¹çª—æ ·å¼ */
      .onboarding-modal {
        background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
      }
      
      .onboarding-step {
        padding: 20px;
      }
      
      .onboarding-welcome {
        text-align: center;
        padding: 20px 0;
      }
      
      .onboarding-emoji {
        width: 80px;
        height: 80px;
        background: #10a37f;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        font-size: 40px;
      }
      
      .onboarding-icon{
        width: 80px;
        height: 80px;
        background: #10a37f;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
      }
      
      .onboarding-icon svg{
        width: 40px;
        height: 40px;
        color: white;
      }
      
      .onboarding-welcome h2{
        font-size: 24px;
        margin-bottom: 8px;
      }
      
      .job-type-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .job-type-item {
        padding: 16px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
      }
      
      .job-type-item:hover {
        background: rgba(255,255,255,0.1);
        border-color: #10a37f;
      }
      
      .job-type-item.selected {
        background: rgba(16,163,127,0.2);
        border-color: #10a37f;
      }
      
      .recommendation-agents {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .recommendation-agent {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
      }
      
      .recommendation-agent .emoji {
        width: 48px;
        height: 48px;
        background: rgba(255,255,255,0.1);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }
      
      .recommendation-agent .emoji svg{
        width: 24px;
        height: 24px;
        color: #10a37f;
      }
      
      .recommendation-agent .info{
        flex: 1;
      }
      
      .recommendation-agent .name {
        font-weight: 600;
        margin-bottom: 4px;
      }
      
      .recommendation-agent .desc {
        font-size: 13px;
        color: rgba(255,255,255,0.6);
      }
      
      .onboarding-complete {
        text-align: center;
        padding: 20px 0;
      }
      
      .team-preview {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 20px;
        flex-wrap: wrap;
      }
      
      .team-preview-avatar {
        width: 48px;
        height: 48px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }
      
      .team-preview-avatar svg{
        width: 24px;
        height: 24px;
        color: #10a37f;
      }
      
      /* ç­¾åˆ°æŒ‰é’® */
      .checkin-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        border-radius: 20px;
        color: white;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        margin-right: 8px;
        border: none;
      }
      
      .checkin-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
      }
      
      .checkin-btn.checked-in {
        background: linear-gradient(135deg, #10a37f 0%, #0d8a6a 100%);
        cursor: default;
      }
      
      .checkin-btn.checked-in:hover {
        transform: none;
        box-shadow: none;
      }
      
      .checkin-icon {
        font-size: 16px;
      }
      
      .checkin-points {
        font-size: 11px;
        opacity: 0.9;
      }
      
      /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
      .theme-toggle-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: #f4f4f4;
        border: none;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .theme-toggle-btn:hover {
        background: #e5e5e5;
        transform: scale(1.05);
      }
    </style>

    <div class="chat-container">
      <div class="messages" id="messages">
        <div class="welcome" id="welcome">
          <div class="welcome-icon">
            <i data-lucide="sparkles" class="icon-lg"></i>
          </div>
          <div class="welcome-title">ä½ å¥½ï¼Œæˆ‘æ˜¯ Lume</div>
          <div class="welcome-desc">ä½ çš„ AI å›¢é˜Ÿé˜Ÿé•¿ï¼Œæ¥è‡ªæ˜Ÿé™…çš„æ™ºèƒ½åŠ©æ‰‹</div>
          <div class="team-tags" id="teamTags"></div>
        </div>
      </div>

      <div class="input-area">
        <div class="input-wrapper">
          <textarea class="input-field" id="inputField" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
          <button class="send-btn" id="sendBtn" onclick="handleSendClick()">
            <i data-lucide="send" class="icon-sm"></i>
          </button>
        </div>
      </div>
    </div>
  </main><!-- /.main-content -->

  <!-- ä¸»é¢˜åˆ‡æ¢ & ä¾§è¾¹æ é€»è¾‘ -->
  <script>
    const THEME_KEY = 'lingxi_theme';
    const SIDEBAR_WIDTH_KEY = 'lingxi_sidebar_width';
    
    // åˆå§‹åŒ–ä¸»é¢˜
    function initTheme() {
      const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
      applyTheme(savedTheme);
    }
    
    // åº”ç”¨ä¸»é¢˜
    function applyTheme(theme) {
      const darkTheme = document.getElementById('darkTheme');
      const toggleIcon = document.getElementById('themeToggleIcon');
      
      if (theme === 'dark') {
        darkTheme.disabled = false;
        if (toggleIcon) toggleIcon.textContent = 'â˜€ï¸';
      } else {
        darkTheme.disabled = true;
        if (toggleIcon) toggleIcon.textContent = 'ğŸŒ™';
      }
      
      localStorage.setItem(THEME_KEY, theme);
    }
    
    // åˆ‡æ¢ä¸»é¢˜
    function toggleTheme() {
      const currentTheme = localStorage.getItem(THEME_KEY) || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      applyTheme(newTheme);
    }

    // ===== ä¾§è¾¹æ åŠŸèƒ½ =====
    function initSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const resizer = document.getElementById('sidebarResizer');
      const savedWidth = localStorage.getItem(SIDEBAR_WIDTH_KEY);
      
      // æ¢å¤ä¿å­˜çš„å®½åº¦ï¼ˆä»…æ¡Œé¢ç«¯ï¼‰
      if (savedWidth && window.innerWidth > 768) {
        sidebar.style.width = savedWidth + 'px';
        mainContent.style.marginLeft = savedWidth + 'px';
        resizer.style.left = savedWidth + 'px';
      }
      
      // åˆå§‹åŒ–æ‹–æ‹½è°ƒæ•´
      initSidebarResizer();
      
      // åŠ è½½ä¼šè¯åˆ—è¡¨ - å»¶è¿Ÿè°ƒç”¨ï¼Œç­‰å¾… chat.js åŠ è½½å®Œæˆ
      // loadSidebarSessions() ä¼šåœ¨ loadSessions() å®Œæˆåè‡ªåŠ¨è°ƒç”¨
      
      // åŠ è½½ç”¨æˆ·ä¿¡æ¯
      loadUserInfo();
    }
    
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const overlay = document.getElementById('sidebarOverlay');
      
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤º/éšè—ä¾§è¾¹æ 
        sidebar.classList.toggle('show');
        overlay.classList.toggle('show');
      } else {
        // æ¡Œé¢ç«¯ï¼šæ”¶èµ·/å±•å¼€
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('expanded');
      }
    }
    
    function initSidebarResizer() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const resizer = document.getElementById('sidebarResizer');
      
      let isResizing = false;
      
      resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        resizer.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const newWidth = Math.max(200, Math.min(400, e.clientX));
        sidebar.style.width = newWidth + 'px';
        mainContent.style.marginLeft = newWidth + 'px';
        resizer.style.left = newWidth + 'px';
      });
      
      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          resizer.classList.remove('dragging');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
          
          // ä¿å­˜å®½åº¦
          const width = parseInt(sidebar.style.width);
          localStorage.setItem(SIDEBAR_WIDTH_KEY, width);
        }
      });
    }
    
    function loadSidebarSessions() {
      console.log('ğŸ”„ loadSidebarSessions è¢«è°ƒç”¨');
      console.log('ğŸ”„ window.sessions:', window.sessions);
      
      const todaySessions = document.getElementById('todaySessions');
      const weekSessions = document.getElementById('weekSessions');
      const olderSessions = document.getElementById('olderSessions');
      
      // è·å–å…¨å±€ä¼šè¯æ•°æ®ï¼ˆä» chat.jsï¼‰
      const allSessions = window.sessions || [];
      console.log('ğŸ”„ allSessions.length:', allSessions.length);
      
      if (allSessions.length === 0) {
        // æ²¡æœ‰ä¼šè¯æ•°æ®æ—¶æ˜¾ç¤ºæç¤º
        console.log('âš ï¸ æ²¡æœ‰ä¼šè¯æ•°æ®');
        todaySessions.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #6e6e80; font-size: 13px;">
            æš‚æ— å†å²ä¼šè¯<br>ç‚¹å‡»ä¸Šæ–¹"æ–°å¯¹è¯"å¼€å§‹
          </div>
        `;
        weekSessions.innerHTML = '';
        olderSessions.innerHTML = '';
        return;
      }
      
      console.log('âœ… å¼€å§‹æ¸²æŸ“', allSessions.length, 'ä¸ªä¼šè¯');
      
      // å»é‡ï¼ˆåŸºäº keyï¼‰
      const uniqueSessions = [];
      const seenKeys = new Set();
      allSessions.forEach(session => {
        if (!seenKeys.has(session.key)) {
          seenKeys.add(session.key);
          uniqueSessions.push(session);
        }
      });
      console.log('âœ… å»é‡å', uniqueSessions.length, 'ä¸ªä¼šè¯');
      
      // æŒ‰æ—¶é—´åˆ†ç»„
      const now = Date.now();
      const today = [];
      const week = [];
      const older = [];
      
      uniqueSessions.forEach(session => {
        const updatedAt = session.updatedAt ? new Date(session.updatedAt).getTime() : 0;
        const daysAgo = (now - updatedAt) / (1000 * 60 * 60 * 24);
        
        if (daysAgo < 1) {
          today.push(session);
        } else if (daysAgo < 7) {
          week.push(session);
        } else {
          older.push(session);
        }
      });
      
      // æ¸²æŸ“ä»Šå¤©çš„ä¼šè¯
      todaySessions.innerHTML = today.map(session => renderSessionItem(session)).join('') || 
        '<div style="padding:10px;color:#6e6e80;font-size:13px;">æš‚æ— ä»Šå¤©çš„å¯¹è¯</div>';
      
      // æ¸²æŸ“æœ€è¿‘7å¤©çš„ä¼šè¯
      weekSessions.innerHTML = week.map(session => renderSessionItem(session)).join('') || '';
      
      // æ¸²æŸ“æ›´æ—©çš„ä¼šè¯
      olderSessions.innerHTML = older.map(session => renderSessionItem(session)).join('') || '';
      
      if (window.lucide) lucide.createIcons();
    }
    
    // æ¸²æŸ“å•ä¸ªä¼šè¯é¡¹
    function renderSessionItem(session) {
      // ä½¿ç”¨ chat.js ä¸­çš„ currentSessionKeyï¼ˆå¦‚æœå¯è®¿é—®ï¼‰
      const currentKey = typeof currentSessionKey !== 'undefined' ? currentSessionKey : window.currentSessionKey;
      const isActive = session.key === currentKey;
      
      console.log('ğŸ“‹ æ¸²æŸ“ä¼šè¯é¡¹:', session.key, 'isActive:', isActive, 'currentKey:', currentKey);
      
      // ç”Ÿæˆæ˜¾ç¤ºåç§°ï¼šä¼˜å…ˆä½¿ç”¨ labelï¼Œå¦åˆ™ç”¨ lastMessage å‰15ä¸ªå­—
      let displayName = session.label || session.displayName;
      if (!displayName) {
        if (session.key === 'main' || session.key.endsWith(':main')) {
          displayName = 'çµçŠ€ï¼ˆä¸»ä¼šè¯ï¼‰';
        } else {
          // ä½¿ç”¨ lastMessage å‰15ä¸ªå­—ä½œä¸ºåç§°
          const lastMsg = session.lastMessage || session.preview || session.last_message || '';
          console.log('ğŸ“‹ lastMsg:', lastMsg);
          if (lastMsg && lastMsg.length > 0) {
            displayName = lastMsg.substring(0, 15) + (lastMsg.length > 15 ? '...' : '');
          } else {
            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯å†…å®¹ï¼Œç”¨æ—¶é—´æˆ³æˆ– key ä½œä¸ºåç§°
            displayName = session.updatedAt 
              ? new Date(session.updatedAt).toLocaleString('zh-CN', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'})
              : 'å¯¹è¯';
          }
        }
      }
      
      // é¢„è§ˆå†…å®¹
      const preview = session.lastMessage || session.preview || session.last_message || '';
      const previewText = preview.substring(0, 30) + (preview.length > 30 ? '...' : '');
      
      // æ—¶é—´
      const time = session.updatedAt ? new Date(session.updatedAt).toLocaleString('zh-CN', {month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'}) : '';
      
      return `
        <div class="sidebar-session ${isActive ? 'active' : ''}" onclick="switchToSession('${session.key}')" title="${escapeHtml(previewText)}">
          <i data-lucide="message-circle" class="icon-sm ${isActive ? 'icon-primary' : ''}"></i>
          <div class="sidebar-session-info">
            <span class="sidebar-session-title">${escapeHtml(displayName)}</span>
            ${time ? `<span class="sidebar-session-time">${time}</span>` : ''}
          </div>
          ${!isActive ? `<button class="sidebar-session-delete" onclick="event.stopPropagation(); deleteSessionFromSidebar('${session.key}')">
            <i data-lucide="trash-2" class="icon-sm"></i>
          </button>` : ''}
        </div>
      `;
    }
    
    // åˆ‡æ¢åˆ°æŒ‡å®šä¼šè¯
    function switchToSession(sessionKey) {
      console.log('ğŸ”„ switchToSession è¢«è°ƒç”¨, sessionKey:', sessionKey);
      
      // ç§»åŠ¨ç«¯å…³é—­ä¾§è¾¹æ 
      if (window.innerWidth <= 768) {
        toggleSidebar();
      }
      
      // è°ƒç”¨ chat.js ä¸­çš„ switchSession å‡½æ•°
      if (typeof switchSession === 'function') {
        console.log('ğŸ“ è°ƒç”¨ chat.js ä¸­çš„ switchSession');
        switchSession(sessionKey);
      } else if (typeof window.switchSession === 'function') {
        console.log('ğŸ“ è°ƒç”¨ window.switchSession');
        window.switchSession(sessionKey);
      } else {
        console.log('âš ï¸ switchSession å‡½æ•°ä¸å­˜åœ¨');
        
        // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ›´æ–° currentSessionKey å¹¶åŠ è½½å†å²
        if (typeof window.currentSessionKey !== 'undefined') {
          window.currentSessionKey = sessionKey;
        }
        if (typeof loadChatHistory === 'function') {
          loadChatHistory();
        }
      }
    }
    
    // ä»ä¾§è¾¹æ åˆ é™¤ä¼šè¯
    function deleteSessionFromSidebar(sessionKey) {
      // è°ƒç”¨ chat.js ä¸­çš„åˆ é™¤å‡½æ•°ï¼ˆå·²æœ‰ç¡®è®¤å¼¹çª—ï¼‰
      if (typeof window.deleteSessionWithRefresh === 'function') {
        window.deleteSessionWithRefresh(sessionKey);
      } else if (typeof deleteSession === 'function') {
        deleteSession(sessionKey);
        // é‡æ–°åŠ è½½ä¾§è¾¹æ 
        setTimeout(() => loadSidebarSessions(), 500);
      }
    }
    
    // HTML è½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function loadUserInfo() {
      const user = JSON.parse(localStorage.getItem('lingxi_user') || '{}');
      if (user.nickname) {
        document.getElementById('sidebarUserName').textContent = user.nickname;
        document.getElementById('sidebarUserAvatar').textContent = user.nickname.charAt(0).toUpperCase();
      }
    }
    
    function newChat() {
      // è°ƒç”¨ chat.js ä¸­çš„åˆ›å»ºæ–°ä¼šè¯å‡½æ•°
      if (typeof createNewSession === 'function') {
        createNewSession();
      }
      
      // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸï¼Œæ˜¾ç¤ºæ¬¢è¿ç•Œé¢
      const messages = document.getElementById('messages');
      messages.innerHTML = `
        <div class="welcome" id="welcome">
          <div class="welcome-icon">
            <i data-lucide="sparkles" class="icon-lg"></i>
          </div>
          <div class="welcome-title">ä½ å¥½ï¼Œæˆ‘æ˜¯ Lume</div>
          <div class="welcome-desc">ä½ çš„ AI å›¢é˜Ÿé˜Ÿé•¿ï¼Œæ¥è‡ªæ˜Ÿé™…çš„æ™ºèƒ½åŠ©æ‰‹</div>
          <div class="team-tags" id="teamTags"></div>
        </div>
      `;
      
      // é‡æ–°æ¸²æŸ“å›¢é˜Ÿæ ‡ç­¾
      if (typeof renderTeamTags === 'function') {
        renderTeamTags();
      }
      
      // é‡æ–°åˆå§‹åŒ– Lucide å›¾æ ‡
      if (window.lucide) {
        lucide.createIcons();
      }
      
      // æ›´æ–°ä¾§è¾¹æ ä¼šè¯åˆ—è¡¨ï¼ˆå–æ¶ˆæ¿€æ´»çŠ¶æ€ï¼‰
      document.querySelectorAll('.sidebar-session').forEach(el => {
        el.classList.remove('active');
      });
    }
    
    function deleteSession(e) {
      e.stopPropagation();
      if (confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªä¼šè¯ï¼Ÿ')) {
        const session = e.target.closest('.sidebar-session');
        session.remove();
      }
    }
    
    // å…³äºå¼¹çª—
    function showAbout() {
      alert('çµçŠ€äº‘ v1.0\n\nä½ çš„ AI å›¢é˜Ÿï¼Œä¸€é”®æ‹¥æœ‰');
    }
    
    // åˆ‡æ¢ç”¨æˆ·èœå•
    function toggleUserMenu() {
      const trigger = document.querySelector('.sidebar-user-trigger');
      const menu = document.getElementById('sidebarUserMenu');
      trigger.classList.toggle('active');
      menu.classList.toggle('show');
    }
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ç”¨æˆ·èœå•
    document.addEventListener('click', (e) => {
      const footer = document.querySelector('.sidebar-footer');
      const menu = document.getElementById('sidebarUserMenu');
      const trigger = document.querySelector('.sidebar-user-trigger');
      
      if (footer && !footer.contains(e.target)) {
        menu.classList.remove('show');
        trigger.classList.remove('active');
      }
    });
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    initTheme();
    initSidebar();
    
    // åˆå§‹åŒ– Lucide å›¾æ ‡
    if (window.lucide) {
      lucide.createIcons();
    }
    
    // ===== ç­¾åˆ°åŠŸèƒ½ =====
    // API åŸºç¡€åœ°å€ï¼ˆå¦‚æœ chat.js è¿˜æ²¡åŠ è½½ï¼‰
    if (typeof API_BASE === 'undefined') {
      window.API_BASE = window.location.origin;
    }
    async function checkCheckinStatus() {
      const token = localStorage.getItem('lingxi_token');
      if (!token) return;
      
      try {
        const res = await fetch(`${API_BASE}/api/auth/checkin/status`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        
        const checkinBtn = document.getElementById('checkinBtn');
        const checkinText = document.getElementById('checkinText');
        const checkinPoints = document.getElementById('checkinPoints');
        
        if (data.checkedIn) {
          checkinBtn.classList.add('checked-in');
          checkinText.textContent = 'å·²ç­¾åˆ°';
          checkinPoints.textContent = `+${data.todayBonus || 10}`;
        } else {
          checkinBtn.classList.remove('checked-in');
          checkinText.textContent = 'ç­¾åˆ°';
          checkinPoints.textContent = '';
        }
      } catch (e) {
        console.error('è·å–ç­¾åˆ°çŠ¶æ€å¤±è´¥:', e);
      }
    }
    
    async function handleCheckin() {
      const token = localStorage.getItem('lingxi_token');
      if (!token) {
        alert('è¯·å…ˆç™»å½•');
        return;
      }
      
      const checkinBtn = document.getElementById('checkinBtn');
      if (checkinBtn.classList.contains('checked-in')) {
        return; // å·²ç­¾åˆ°
      }
      
      try {
        checkinBtn.disabled = true;
        const res = await fetch(`${API_BASE}/api/auth/checkin`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        const data = await res.json();
        
        if (data.ok || res.ok) {
          checkinBtn.classList.add('checked-in');
          document.getElementById('checkinText').textContent = 'å·²ç­¾åˆ°';
          document.getElementById('checkinPoints').textContent = `+${data.bonus || 10}`;
          alert(data.message || `ç­¾åˆ°æˆåŠŸï¼è·å¾— ${data.bonus || 10} ç§¯åˆ†`);
        } else {
          alert(data.message || 'ç­¾åˆ°å¤±è´¥');
        }
      } catch (e) {
        console.error('ç­¾åˆ°å¤±è´¥:', e);
        alert('ç­¾åˆ°å¤±è´¥ï¼Œè¯·é‡è¯•');
      } finally {
        checkinBtn.disabled = false;
      }
    }
    
    // æ£€æŸ¥ç­¾åˆ°çŠ¶æ€
    checkCheckinStatus();
  </script>
  
  <script src="assets/js/chat.js"></script>
</body>
</html>
