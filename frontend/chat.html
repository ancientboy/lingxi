<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„ AI å›¢é˜Ÿ - çµçŠ€äº‘</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0f;
      min-height: 100vh;
      color: #fff;
      display: flex;
      flex-direction: column;
    }
    
    .navbar {
      background: rgba(20, 20, 30, 0.95);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #00d4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      cursor: pointer;
      text-decoration: none;
    }
    .nav-left { display: flex; align-items: center; gap: 15px; }
    .nav-right { display: flex; align-items: center; gap: 10px; }
    .nav-btn {
      padding: 8px 14px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
      color: rgba(255,255,255,0.8);
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
    }
    .nav-btn:hover { background: rgba(255,255,255,0.1); }
    .nav-btn.primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      color: #fff;
    }
    
    /* ç”¨æˆ·ä¿¡æ¯ */
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      cursor: pointer;
    }
    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .user-name {
      font-size: 13px;
      color: rgba(255,255,255,0.8);
    }
    
    /* ä¸‹æ‹‰èœå• */
    .dropdown {
      position: relative;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: rgba(30, 30, 40, 0.98);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      min-width: 180px;
      padding: 8px 0;
      z-index: 200;
    }
    .dropdown:hover .dropdown-content,
    .dropdown-content.show {
      display: block;
    }
    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .dropdown-item:hover {
      background: rgba(255,255,255,0.05);
    }
    .dropdown-item.danger { color: #f87171; }
    .dropdown-divider {
      height: 1px;
      background: rgba(255,255,255,0.1);
      margin: 8px 0;
    }
    
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      padding: 20px;
    }
    
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .welcome {
      text-align: center;
      padding: 60px 20px;
    }
    .welcome-emoji {
      font-size: 64px;
      margin-bottom: 20px;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .welcome-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea, #00d4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .welcome-desc {
      font-size: 16px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 20px;
    }
    .team-tags {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .team-tag {
      padding: 6px 14px;
      background: rgba(102, 126, 234, 0.2);
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 20px;
      font-size: 13px;
    }
    
    .message {
      display: flex;
      gap: 12px;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message.user {
      flex-direction: row-reverse;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    .message.user .avatar { background: linear-gradient(135deg, #667eea, #764ba2); }
    .message.assistant .avatar { background: linear-gradient(135deg, #00d4ff, #667eea); }
    
    .bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.5;
    }
    .message.user .bubble {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-bottom-right-radius: 4px;
    }
    .message.assistant .bubble {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.1);
      border-bottom-left-radius: 4px;
    }
    
    .typing {
      display: flex;
      gap: 4px;
      padding: 16px;
    }
    .typing span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
      animation: typing 1.4s infinite;
    }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 100% { transform: translateY(0); opacity: 0.5; }
      50% { transform: translateY(-6px); opacity: 1; }
    }
    
    .input-area {
      padding: 20px;
      background: rgba(20, 20, 30, 0.95);
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .quick-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .quick-btn {
      padding: 6px 12px;
      font-size: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      border-radius: 16px;
      cursor: pointer;
    }
    .quick-btn:hover { background: rgba(255,255,255,0.1); }
    
    .input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    .input-field {
      flex: 1;
      padding: 14px 18px;
      font-size: 15px;
      color: #fff;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 24px;
      outline: none;
      resize: none;
      max-height: 150px;
    }
    .input-field:focus {
      border-color: rgba(102, 126, 234, 0.5);
    }
    .send-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .send-btn:hover { transform: scale(1.05); }
    
    .hidden { display: none !important; }
    
    .status {
      padding: 8px 16px;
      font-size: 12px;
      color: rgba(255,255,255,0.5);
      text-align: center;
    }
    .status.connected { color: #4ade80; }
    .status.error { color: #f87171; }
    
    /* å¼¹çª—æ ·å¼ */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: rgba(20, 20, 30, 0.98);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow: hidden;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      background: linear-gradient(135deg, #667eea, #00d4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .close-btn {
      background: none;
      border: none;
      color: rgba(255,255,255,0.6);
      font-size: 24px;
      cursor: pointer;
    }
    .close-btn:hover { color: #fff; }
    .modal-body {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }
    
    /* å›¢é˜Ÿåˆ—è¡¨ */
    .team-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .team-member {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
    }
    .team-member-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .team-member-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .team-member-name {
      font-weight: 600;
    }
    .team-member-role {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
    }
    .remove-btn {
      padding: 6px 12px;
      font-size: 12px;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #f87171;
      border-radius: 6px;
      cursor: pointer;
    }
    .remove-btn:hover { background: rgba(239, 68, 68, 0.3); }
    
    /* æ·»åŠ æˆå‘˜ */
    .add-team-section h4 {
      font-size: 14px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 12px;
    }
    .available-agents {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .agent-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .agent-chip:hover {
      background: rgba(102, 126, 234, 0.2);
      border-color: rgba(102, 126, 234, 0.5);
    }
    .agent-chip.added {
      background: rgba(74, 222, 128, 0.2);
      border-color: rgba(74, 222, 128, 0.3);
      color: #4ade80;
    }
    
    /* ä¼šè¯åˆ—è¡¨ */
    .session-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .session-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .session-item:hover { background: rgba(255,255,255,0.1); }
    .session-item.active {
      background: rgba(102, 126, 234, 0.2);
      border: 1px solid rgba(102, 126, 234, 0.3);
    }
    .session-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .session-info {
      flex: 1;
    }
    .session-name {
      font-weight: 600;
    }
    .session-preview {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
    }
    
    /* è¡¨å•æ ·å¼ */
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 6px;
    }
    .form-group input {
      width: 100%;
      padding: 12px 14px;
      font-size: 14px;
      color: #fff;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      outline: none;
    }
    .form-group input:focus {
      border-color: rgba(102, 126, 234, 0.5);
    }
    .submit-btn {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .submit-btn:hover { transform: translateY(-2px); }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-left">
      <a href="index.html" class="logo">âš¡ çµçŠ€äº‘</a>
      <div class="status" id="connectionStatus">è¿æ¥ä¸­...</div>
    </div>
    <div class="nav-right">
      <button class="nav-btn" onclick="showSessionList()">ğŸ’¬ ä¼šè¯</button>
      <button class="nav-btn" onclick="clearChat()">ğŸ—‘ï¸ æ¸…ç©º</button>
      <div class="dropdown">
        <div class="user-info" onclick="toggleDropdown()">
          <div class="user-avatar">ğŸ‘¤</div>
          <div class="user-name" id="navUserName">ç”¨æˆ·</div>
        </div>
        <div class="dropdown-content" id="userDropdown">
          <div class="dropdown-item" onclick="showMyTeam()">ğŸ‘¥ æˆ‘çš„å›¢é˜Ÿ</div>
          <div class="dropdown-divider"></div>
          <div class="dropdown-item" onclick="showFeishuConfig()">ğŸ“± é£ä¹¦é…ç½®</div>
          <div class="dropdown-item" onclick="showWecomConfig()">ğŸ’¼ ä¼ä¸šå¾®ä¿¡</div>
          <div class="dropdown-divider"></div>
          <div class="dropdown-item" onclick="showPasswordChange()">ğŸ”’ ä¿®æ”¹å¯†ç </div>
          <div class="dropdown-item" onclick="showSettings()">âš™ï¸ è®¾ç½®</div>
          <div class="dropdown-item" onclick="showAbout()">â„¹ï¸ å…³äº</div>
          <div class="dropdown-divider"></div>
          <div class="dropdown-item danger" onclick="logout()">ğŸšª é€€å‡ºç™»å½•</div>
        </div>
      </div>
    </div>
  </nav>

  <!-- å›¢é˜Ÿç®¡ç†å¼¹çª— -->
  <div class="modal-overlay" id="teamModal">
    <div class="modal team-modal">
      <div class="modal-header">
        <h3>ğŸ‘¥ æˆ‘çš„å›¢é˜Ÿ</h3>
        <button class="close-btn" onclick="closeTeamModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="team-list" id="myTeamList"></div>
        <div class="add-team-section">
          <h4>æ·»åŠ æˆå‘˜</h4>
          <div class="available-agents" id="availableAgents"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¼šè¯åˆ—è¡¨å¼¹çª— -->
  <div class="modal-overlay" id="sessionModal">
    <div class="modal">
      <div class="modal-header">
        <h3>ğŸ’¬ ä¼šè¯åˆ—è¡¨</h3>
        <button class="close-btn" onclick="closeSessionModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="session-list" id="sessionList">
          <div class="session-item active">
            <div class="session-avatar">âš¡</div>
            <div class="session-info">
              <div class="session-name">çµçŠ€ï¼ˆå½“å‰ï¼‰</div>
              <div class="session-preview">ä¸çµçŠ€é˜Ÿé•¿çš„å¯¹è¯</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- é£ä¹¦é…ç½®å¼¹çª— -->
  <div class="modal-overlay" id="feishuModal">
    <div class="modal">
      <div class="modal-header">
        <h3>ğŸ“± é£ä¹¦é…ç½®</h3>
        <button class="close-btn" onclick="closeFeishuModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="feishuStatus" style="margin-bottom:16px;"></div>
        <form id="feishuForm" onsubmit="saveFeishuConfig(event)">
          <div class="form-group">
            <label>App ID</label>
            <input type="text" id="feishuAppId" placeholder="cli_xxxxxxxxxxxx" autocomplete="off">
          </div>
          <div class="form-group">
            <label>App Secret</label>
            <input type="password" id="feishuAppSecret" placeholder="åº”ç”¨å¯†é’¥" autocomplete="off">
          </div>
          <button type="submit" class="submit-btn">ä¿å­˜é…ç½®</button>
        </form>
        <div id="feishuWebhook" style="margin-top:16px;display:none;">
          <label style="font-size:12px;color:rgba(255,255,255,0.6);">Webhook åœ°å€ï¼ˆå¤åˆ¶åˆ°é£ä¹¦å¼€æ”¾å¹³å°ï¼‰</label>
          <div style="display:flex;gap:8px;margin-top:6px;">
            <input type="text" id="feishuWebhookUrl" readonly style="flex:1;font-size:12px;">
            <button type="button" class="nav-btn" onclick="copyFeishuWebhook()">å¤åˆ¶</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¼ä¸šå¾®ä¿¡é…ç½®å¼¹çª— -->
  <div class="modal-overlay" id="wecomModal">
    <div class="modal">
      <div class="modal-header">
        <h3>ğŸ’¼ ä¼ä¸šå¾®ä¿¡é…ç½®</h3>
        <button class="close-btn" onclick="closeWecomModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="wecomStatus" style="margin-bottom:16px;"></div>
        <form id="wecomForm" onsubmit="saveWecomConfig(event)">
          <div class="form-group">
            <label>ä¼ä¸š ID (Corp ID)</label>
            <input type="text" id="wecomCorpId" placeholder="wwxxxxxxxxxxxxxx" autocomplete="off">
          </div>
          <div class="form-group">
            <label>Agent ID</label>
            <input type="text" id="wecomAgentId" placeholder="1000001" autocomplete="off">
          </div>
          <div class="form-group">
            <label>Agent Secret</label>
            <input type="password" id="wecomAgentSecret" placeholder="åº”ç”¨å¯†é’¥" autocomplete="off">
          </div>
          <button type="submit" class="submit-btn">ä¿å­˜é…ç½®</button>
        </form>
        <div id="wecomWebhook" style="margin-top:16px;display:none;">
          <label style="font-size:12px;color:rgba(255,255,255,0.6);">å›è°ƒåœ°å€</label>
          <div style="display:flex;gap:8px;margin-top:6px;">
            <input type="text" id="wecomWebhookUrl" readonly style="flex:1;font-size:12px;">
            <button type="button" class="nav-btn" onclick="copyWecomWebhook()">å¤åˆ¶</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¿®æ”¹å¯†ç å¼¹çª— -->
  <div class="modal-overlay" id="passwordModal">
    <div class="modal">
      <div class="modal-header">
        <h3>ğŸ”’ ä¿®æ”¹å¯†ç </h3>
        <button class="close-btn" onclick="closePasswordModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <form id="passwordForm" onsubmit="changePassword(event)">
          <div class="form-group">
            <label>å½“å‰å¯†ç </label>
            <input type="password" id="currentPassword" placeholder="è¾“å…¥å½“å‰å¯†ç " required>
          </div>
          <div class="form-group">
            <label>æ–°å¯†ç </label>
            <input type="password" id="newPassword" placeholder="è‡³å°‘6ä½" required minlength="6">
          </div>
          <div class="form-group">
            <label>ç¡®è®¤æ–°å¯†ç </label>
            <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " required>
          </div>
          <button type="submit" class="submit-btn">ä¿®æ”¹å¯†ç </button>
        </form>
      </div>
    </div>
  </div>

  <div class="chat-container">
    <div class="messages" id="messages">
      <div class="welcome" id="welcome">
        <div class="welcome-emoji">âš¡</div>
        <div class="welcome-title">ä½ å¥½ï¼æˆ‘æ˜¯çµçŠ€</div>
        <div class="welcome-desc">ä½ çš„ AI å›¢é˜Ÿé˜Ÿé•¿ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ</div>
        <div class="team-tags" id="teamTags"></div>
      </div>
    </div>

    <div class="input-area">
      <div class="quick-actions">
        <button class="quick-btn" onclick="quickSend('å¸®æˆ‘å†™ä¸€ä¸ªè„šæœ¬')">ğŸ“ å†™è„šæœ¬</button>
        <button class="quick-btn" onclick="quickSend('åˆ†æä¸€ä¸‹è¿™ä¸ªæ•°æ®')">ğŸ“Š åˆ†ææ•°æ®</button>
        <button class="quick-btn" onclick="quickSend('å¸®æˆ‘åšä¸ªè®¡åˆ’')">ğŸ“‹ åšè®¡åˆ’</button>
        <button class="quick-btn" onclick="quickSend('ç»™ç‚¹åˆ›æ„å»ºè®®')">ğŸ’¡ åˆ›æ„å»ºè®®</button>
      </div>
      <div class="input-wrapper">
        <textarea class="input-field" id="inputField" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">â¤</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    const GATEWAY_WS = `ws://${window.location.hostname}:18789`;
    const GATEWAY_TOKEN = '6f3719a52fa12799fea8e4a06655703f';
    const SESSION_KEY = 'c308f1f0';
    
    const AGENT_INFO = {
      lingxi: { emoji: 'âš¡', name: 'çµçŠ€', desc: 'é˜Ÿé•¿Â·è°ƒåº¦å‘˜' },
      coder: { emoji: 'ğŸ’»', name: 'äº‘æºª', desc: 'ä»£ç å¥³ç‹' },
      ops: { emoji: 'ğŸ“Š', name: 'è‹¥æ›¦', desc: 'è¿è¥ä¸“å®¶' },
      inventor: { emoji: 'ğŸ’¡', name: 'ç´«è±', desc: 'åˆ›æ„å¤©æ‰' },
      pm: { emoji: 'ğŸ¯', name: 'æ¢“è±', desc: 'äº§å“å¥³ç‹' },
      noter: { emoji: 'ğŸ“', name: 'æ™“ç³', desc: 'çŸ¥è¯†ç®¡ç†' },
      media: { emoji: 'ğŸ§', name: 'éŸ³éŸµ', desc: 'å¤šåª’ä½“ä¸“å®¶' },
      smart: { emoji: 'ğŸ ', name: 'æ™ºå®¶', desc: 'æ™ºèƒ½å®¶å±…' }
    };
    
    let user = null;
    let ws = null;
    let pendingMessage = null;
    
    // åˆå§‹åŒ–
    function init() {
      const token = localStorage.getItem('lingxi_token');
      if (!token) {
        window.location.href = 'index.html';
        return;
      }
      
      user = JSON.parse(localStorage.getItem('lingxi_user') || '{}');
      renderTeamTags();
      connectWebSocket();
      
      document.getElementById('inputField').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      document.getElementById('inputField').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 150) + 'px';
      });
    }
    
    let requestId = 1;
    let connectNonce = null;
    
    // WebSocket è¿æ¥
    function connectWebSocket() {
      const statusEl = document.getElementById('connectionStatus');
      statusEl.textContent = 'è¿æ¥ä¸­...';
      statusEl.className = 'status';
      
      try {
        ws = new WebSocket(`${GATEWAY_WS}/${SESSION_KEY}/ws`);
        
        ws.onopen = () => {
          console.log('WebSocket å·²è¿æ¥ï¼Œç­‰å¾… 750ms åå‘é€ connect...');
          statusEl.textContent = 'è®¤è¯ä¸­...';
          
          // OpenClaw è¦æ±‚ç­‰å¾… 750ms åå†å‘é€ connect
          setTimeout(() => {
            sendConnect();
          }, 750);
        };
        
        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            handleWebSocketMessage(data);
          } catch (e) {
            console.error('è§£ææ¶ˆæ¯å¤±è´¥:', e);
          }
        };
        
        ws.onerror = (error) => {
          console.error('WebSocket é”™è¯¯:', error);
          statusEl.textContent = 'è¿æ¥é”™è¯¯';
          statusEl.className = 'status error';
        };
        
        ws.onclose = () => {
          console.log('WebSocket å·²æ–­å¼€');
          statusEl.textContent = 'å·²æ–­å¼€ï¼Œ5ç§’åé‡è¿...';
          statusEl.className = 'status error';
          setTimeout(connectWebSocket, 5000);
        };
      } catch (e) {
        console.error('WebSocket è¿æ¥å¤±è´¥:', e);
        statusEl.textContent = 'è¿æ¥å¤±è´¥';
        statusEl.className = 'status error';
      }
    }
    
    // å‘é€ connect è¯·æ±‚
    function sendConnect() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      
      const params = {
        minProtocol: 3,
        maxProtocol: 3,
        client: {
          id: 'webchat',  // å¿…é¡»æ˜¯é¢„å®šä¹‰å€¼: webchat, cli, openclaw-control-ui ç­‰
          version: '1.0.0',
          platform: 'web',
          mode: 'webchat'
        },
        role: 'operator',
        scopes: ['operator.admin', 'operator.read', 'operator.write'],
        auth: { token: GATEWAY_TOKEN },
        locale: 'zh-CN',
        userAgent: navigator.userAgent
      };
      
      // ç¦ç”¨è®¾å¤‡è®¤è¯åä¸éœ€è¦å‘é€ device
      ws.send(JSON.stringify({
        type: 'req',
        id: `req_${requestId++}`,
        method: 'connect',
        params
      }));
    }
    
    // å¤„ç† WebSocket æ¶ˆæ¯
    function handleWebSocketMessage(data) {
      console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
      
      const statusEl = document.getElementById('connectionStatus');
      
      // è¿æ¥æŒ‘æˆ˜ - è®¾å¤‡è®¤è¯å·²ç¦ç”¨æ—¶ä¸åº”è¯¥æ”¶åˆ°
      if (data.type === 'event' && data.event === 'connect.challenge') {
        console.log('æ”¶åˆ°æŒ‘æˆ˜ï¼Œä½†è®¾å¤‡è®¤è¯å·²ç¦ç”¨ï¼Œè¿™ä¸åº”è¯¥å‘ç”Ÿ');
        statusEl.textContent = 'è®¤è¯å¤±è´¥ï¼ˆéœ€è¦é‡å¯Gatewayï¼‰';
        statusEl.className = 'status error';
        return;
      }
      
      // è¿æ¥å“åº”
      if (data.type === 'res' && data.ok && data.payload?.type === 'hello-ok') {
        statusEl.textContent = 'å·²è¿æ¥';
        statusEl.className = 'status connected';
        console.log('âœ… è®¤è¯æˆåŠŸ');
        return;
      }
      
      // chat.send å“åº” (å¼€å§‹è¿è¡Œ)
      if (data.type === 'res' && data.payload?.status === 'started') {
        console.log('æ¶ˆæ¯å‘é€ä¸­ï¼ŒrunId:', data.payload.runId);
        return;
      }
      
      // é”™è¯¯å“åº”
      if (data.type === 'res' && !data.ok) {
        statusEl.textContent = 'è®¤è¯å¤±è´¥';
        statusEl.className = 'status error';
        console.error('è®¤è¯å¤±è´¥:', data);
        removeTyping();
        addMessage('assistant', 'è®¤è¯å¤±è´¥: ' + (data.error?.message || 'æœªçŸ¥é”™è¯¯'), 'çµçŠ€');
        return;
      }
      
      // èŠå¤©å“åº”äº‹ä»¶
      if (data.type === 'event' && data.event === 'chat') {
        const payload = data.payload || {};
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ä¼šè¯
        if (payload.sessionKey && payload.sessionKey !== SESSION_KEY) {
          return;
        }
        
        // delta - æµå¼è¾“å‡º
        if (payload.state === 'delta') {
          const text = extractText(payload.message);
          if (text) {
            updateLastAssistantMessage(text);
          }
        }
        // final - å®Œæˆ
        else if (payload.state === 'final') {
          const text = extractText(payload.message);
          removeTyping();
          if (text) {
            addMessage('assistant', text, 'çµçŠ€');
          }
        }
        // error
        else if (payload.state === 'error') {
          removeTyping();
          addMessage('assistant', 'é”™è¯¯: ' + (payload.errorMessage || 'æœªçŸ¥é”™è¯¯'), 'çµçŠ€');
        }
        // aborted
        else if (payload.state === 'aborted') {
          removeTyping();
          addMessage('assistant', 'å·²ä¸­æ­¢', 'çµçŠ€');
        }
      }
    }
    
    // ä»æ¶ˆæ¯å¯¹è±¡ä¸­æå–æ–‡æœ¬
    function extractText(message) {
      if (!message) return null;
      if (typeof message === 'string') return message;
      if (message.text) return message.text;
      if (message.content) {
        if (typeof message.content === 'string') return message.content;
        if (Array.isArray(message.content)) {
          return message.content
            .filter(block => block.type === 'text')
            .map(block => block.text)
            .join('');
        }
      }
      return null;
    }
    
    // æ¸²æŸ“å›¢é˜Ÿæ ‡ç­¾
    function renderTeamTags() {
      const agents = user?.agents || ['lingxi'];
      const tags = document.getElementById('teamTags');
      tags.innerHTML = agents.map(id => {
        const agent = AGENT_INFO[id] || { emoji: 'ğŸ¤–', name: id };
        return `<span class="team-tag">${agent.emoji} ${agent.name}</span>`;
      }).join('');
    }
    
    // å‘é€æ¶ˆæ¯
    function sendMessage() {
      const input = document.getElementById('inputField');
      const text = input.value.trim();
      if (!text) return;
      
      document.getElementById('welcome').classList.add('hidden');
      addMessage('user', text, user?.nickname || 'æˆ‘');
      input.value = '';
      input.style.height = 'auto';
      
      // é€šè¿‡ WebSocket å‘é€
      if (ws && ws.readyState === WebSocket.OPEN) {
        addTyping();
        ws.send(JSON.stringify({
          type: 'req',
          id: `req_${requestId++}`,
          method: 'chat.send',
          params: {
            sessionKey: SESSION_KEY,
            message: text,
            idempotencyKey: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            deliver: false
          }
        }));
      } else {
        // WebSocket æœªè¿æ¥ï¼Œä½¿ç”¨ HTTP ä»£ç†
        sendViaHTTP(text);
      }
    }
    
    // HTTP ä»£ç†å¤‡ç”¨æ–¹æ¡ˆ
    async function sendViaHTTP(text) {
      const loadingId = addTyping();
      try {
        const res = await fetch(`${API_BASE}/api/chat/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: text,
            userId: user?.id || 'web-user'
          })
        });
        
        removeTyping();
        
        if (res.ok) {
          const data = await res.json();
          addMessage('assistant', data.response || 'æ”¶åˆ°~', 'çµçŠ€');
        } else {
          addMessage('assistant', 'ç½‘ç»œå‡ºäº†ç‚¹é—®é¢˜ï¼Œç¨åå†è¯•~', 'çµçŠ€');
        }
      } catch (e) {
        removeTyping();
        addMessage('assistant', 'è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ~', 'çµçŠ€');
      }
    }
    
    // å¿«æ·å‘é€
    function quickSend(text) {
      document.getElementById('inputField').value = text;
      sendMessage();
    }
    
    // æ·»åŠ æ¶ˆæ¯
    function addMessage(role, content, name) {
      const messages = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = `message ${role}`;
      
      const emoji = role === 'user' ? 'ğŸ‘¤' : 'âš¡';
      
      div.innerHTML = `
        <div class="avatar">${emoji}</div>
        <div class="bubble">${escapeHtml(content)}</div>
      `;
      
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      
      return div;
    }
    
    // æ·»åŠ æ‰“å­—åŠ¨ç”»
    function addTyping() {
      const messages = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'message assistant';
      div.id = 'typing-indicator';
      div.innerHTML = `
        <div class="avatar">âš¡</div>
        <div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div>
      `;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return div.id;
    }
    
    // ç§»é™¤æ‰“å­—åŠ¨ç”»
    function removeTyping() {
      const el = document.getElementById('typing-indicator');
      if (el) el.remove();
    }
    
    // æ›´æ–°æœ€åä¸€æ¡åŠ©æ‰‹æ¶ˆæ¯
    function updateLastAssistantMessage(content) {
      removeTyping();
      const messages = document.getElementById('messages');
      const lastMsg = messages.querySelector('.message.assistant:last-child .bubble');
      if (lastMsg) {
        lastMsg.innerHTML = escapeHtml(content);
      } else {
        addMessage('assistant', content, 'çµçŠ€');
      }
      messages.scrollTop = messages.scrollHeight;
    }
    
    // æ¸…ç©ºèŠå¤©
    function clearChat() {
      const messages = document.getElementById('messages');
      messages.innerHTML = '';
      document.getElementById('welcome').classList.remove('hidden');
    }
    
    // åˆ‡æ¢ä¸‹æ‹‰èœå•
    function toggleDropdown() {
      const dropdown = document.getElementById('userDropdown');
      dropdown.classList.toggle('show');
    }
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.dropdown')) {
        document.getElementById('userDropdown')?.classList.remove('show');
      }
    });
    
    // æ˜¾ç¤ºè®¾ç½®
    function showSettings() {
      alert('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...');
    }
    
    // æ˜¾ç¤ºå…³äº
    function showAbout() {
      alert('çµçŠ€äº‘ v1.0\n\nä½ çš„ AI å›¢é˜Ÿï¼Œä¸€é”®æ‹¥æœ‰');
    }
    
    // é€€å‡ºç™»å½•
    function logout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        localStorage.removeItem('lingxi_token');
        localStorage.removeItem('lingxi_user');
        window.location.href = 'index.html';
      }
    }
    
    // ===== å›¢é˜Ÿç®¡ç† =====
    
    // æ˜¾ç¤ºæˆ‘çš„å›¢é˜Ÿ
    function showMyTeam() {
      document.getElementById('userDropdown').classList.remove('show');
      renderMyTeam();
      renderAvailableAgents();
      document.getElementById('teamModal').classList.add('show');
    }
    
    // å…³é—­å›¢é˜Ÿå¼¹çª—
    function closeTeamModal() {
      document.getElementById('teamModal').classList.remove('show');
    }
    
    // æ¸²æŸ“æˆ‘çš„å›¢é˜Ÿ
    function renderMyTeam() {
      const myAgents = user?.agents || ['lingxi'];
      const container = document.getElementById('myTeamList');
      
      if (myAgents.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:rgba(255,255,255,0.5);">è¿˜æ²¡æœ‰æ·»åŠ å›¢é˜Ÿæˆå‘˜</p>';
        return;
      }
      
      container.innerHTML = myAgents.map(agentId => {
        const agent = AGENT_INFO[agentId] || { emoji: 'ğŸ¤–', name: agentId };
        const isRequired = agentId === 'lingxi';
        return `
          <div class="team-member">
            <div class="team-member-info">
              <div class="team-member-avatar">${agent.emoji}</div>
              <div>
                <div class="team-member-name">${agent.name}</div>
                <div class="team-member-role">${agent.desc || 'AI åŠ©æ‰‹'}</div>
              </div>
            </div>
            ${isRequired ? 
              '<span style="color:rgba(255,255,255,0.4);font-size:12px;">é˜Ÿé•¿</span>' : 
              `<button class="remove-btn" onclick="removeAgent('${agentId}')">ç§»é™¤</button>`
            }
          </div>
        `;
      }).join('');
    }
    
    // æ¸²æŸ“å¯æ·»åŠ çš„æˆå‘˜
    function renderAvailableAgents() {
      const myAgents = user?.agents || ['lingxi'];
      const container = document.getElementById('availableAgents');
      
      const available = Object.keys(AGENT_INFO).filter(id => !myAgents.includes(id));
      
      if (available.length === 0) {
        container.innerHTML = '<p style="color:rgba(255,255,255,0.4);font-size:13px;">å·²æ·»åŠ å…¨éƒ¨æˆå‘˜</p>';
        return;
      }
      
      container.innerHTML = available.map(agentId => {
        const agent = AGENT_INFO[agentId];
        return `
          <div class="agent-chip" onclick="addAgent('${agentId}')">
            <span>${agent.emoji}</span>
            <span>${agent.name}</span>
          </div>
        `;
      }).join('');
    }
    
    // æ·»åŠ æˆå‘˜
    async function addAgent(agentId) {
      if (!user) return;
      
      const myAgents = user.agents || ['lingxi'];
      if (myAgents.includes(agentId)) return;
      
      myAgents.push(agentId);
      user.agents = myAgents;
      
      // ä¿å­˜åˆ°æœåŠ¡å™¨
      try {
        const res = await fetch(`${API_BASE}/api/agents/user/${user.id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('lingxi_token')}`
          },
          body: JSON.stringify({ agents: myAgents })
        });
        
        const data = await res.json();
        
        if (res.ok && data.success) {
          localStorage.setItem('lingxi_user', JSON.stringify(user));
          renderMyTeam();
          renderAvailableAgents();
          renderTeamTags();
          console.log('âœ… æˆå‘˜æ·»åŠ æˆåŠŸ:', agentId);
        } else {
          // å›æ»š
          user.agents = user.agents.filter(id => id !== agentId);
          alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (e) {
        // å›æ»š
        user.agents = user.agents.filter(id => id !== agentId);
        alert('ç½‘ç»œé”™è¯¯ï¼š' + e.message);
      }
    }
    
    // ç§»é™¤æˆå‘˜
    async function removeAgent(agentId) {
      if (!user) return;
      if (agentId === 'lingxi') return; // é˜Ÿé•¿ä¸èƒ½ç§»é™¤
      
      const myAgents = user.agents || ['lingxi'];
      const newAgents = myAgents.filter(id => id !== agentId);
      
      if (newAgents.length === 0) {
        alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªå›¢é˜Ÿæˆå‘˜');
        return;
      }
      
      const oldAgents = [...user.agents];
      user.agents = newAgents;
      
      // ä¿å­˜åˆ°æœåŠ¡å™¨
      try {
        const res = await fetch(`${API_BASE}/api/agents/user/${user.id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('lingxi_token')}`
          },
          body: JSON.stringify({ agents: newAgents })
        });
        
        const data = await res.json();
        
        if (res.ok && data.success) {
          localStorage.setItem('lingxi_user', JSON.stringify(user));
          renderMyTeam();
          renderAvailableAgents();
          renderTeamTags();
          console.log('âœ… æˆå‘˜ç§»é™¤æˆåŠŸ:', agentId);
        } else {
          // å›æ»š
          user.agents = oldAgents;
          alert('ç§»é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (e) {
        // å›æ»š
        user.agents = oldAgents;
        alert('ç½‘ç»œé”™è¯¯ï¼š' + e.message);
      }
    }
    
    // ===== ä¼šè¯åˆ—è¡¨ =====
    
    function showSessionList() {
      document.getElementById('sessionModal').classList.add('show');
    }
    
    function closeSessionModal() {
      document.getElementById('sessionModal').classList.remove('show');
    }
    
    // ===== é£ä¹¦é…ç½® =====
    
    function showFeishuConfig() {
      document.getElementById('userDropdown').classList.remove('show');
      
      if (!user || !user.id) {
        alert('è¯·å…ˆç™»å½•');
        return;
      }
      
      loadFeishuStatus();
      document.getElementById('feishuModal').classList.add('show');
    }
    
    function closeFeishuModal() {
      document.getElementById('feishuModal').classList.remove('show');
    }
    
    async function loadFeishuStatus() {
      const statusEl = document.getElementById('feishuStatus');
      statusEl.innerHTML = '<span style="color:rgba(255,255,255,0.5)">åŠ è½½ä¸­...</span>';
      
      try {
        const res = await fetch(`${API_BASE}/api/feishu/status/${user.id}`);
        const data = await res.json();
        
        if (data.configured) {
          statusEl.innerHTML = `<span style="color:#4ade80">âœ… å·²é…ç½® (${data.botName})</span>`;
          document.getElementById('feishuWebhook').style.display = 'block';
          document.getElementById('feishuWebhookUrl').value = data.webhookUrl;
        } else {
          statusEl.innerHTML = '<span style="color:rgba(255,255,255,0.5)">æœªé…ç½®</span>';
          document.getElementById('feishuWebhook').style.display = 'none';
        }
      } catch (e) {
        statusEl.innerHTML = '<span style="color:#f87171">åŠ è½½å¤±è´¥</span>';
      }
    }
    
    async function saveFeishuConfig(e) {
      e.preventDefault();
      
      const appId = document.getElementById('feishuAppId').value.trim();
      const appSecret = document.getElementById('feishuAppSecret').value.trim();
      
      if (!appId || !appSecret) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/api/feishu/configure`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: user.id, appId, appSecret })
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert('é£ä¹¦é…ç½®æˆåŠŸï¼\n\nè¯·åœ¨é£ä¹¦å¼€æ”¾å¹³å°é…ç½®äº‹ä»¶è®¢é˜…ï¼š\n' + data.config.webhookUrl);
          loadFeishuStatus();
        } else {
          alert('é…ç½®å¤±è´¥: ' + (data.error || data.detail || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (e) {
        alert('ç½‘ç»œé”™è¯¯: ' + e.message);
      }
    }
    
    function copyFeishuWebhook() {
      const input = document.getElementById('feishuWebhookUrl');
      input.select();
      document.execCommand('copy');
      alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }
    
    // ===== ä¼ä¸šå¾®ä¿¡é…ç½® =====
    
    function showWecomConfig() {
      document.getElementById('userDropdown').classList.remove('show');
      
      if (!user || !user.id) {
        alert('è¯·å…ˆç™»å½•');
        return;
      }
      
      loadWecomStatus();
      document.getElementById('wecomModal').classList.add('show');
    }
    
    function closeWecomModal() {
      document.getElementById('wecomModal').classList.remove('show');
    }
    
    async function loadWecomStatus() {
      const statusEl = document.getElementById('wecomStatus');
      statusEl.innerHTML = '<span style="color:rgba(255,255,255,0.5)">åŠ è½½ä¸­...</span>';
      
      try {
        const res = await fetch(`${API_BASE}/api/wecom/status/${user.id}`);
        const data = await res.json();
        
        if (data.configured) {
          statusEl.innerHTML = `<span style="color:#4ade80">âœ… å·²é…ç½®</span>`;
          document.getElementById('wecomWebhook').style.display = 'block';
          document.getElementById('wecomWebhookUrl').value = data.webhookUrl;
        } else {
          statusEl.innerHTML = '<span style="color:rgba(255,255,255,0.5)">æœªé…ç½®</span>';
          document.getElementById('wecomWebhook').style.display = 'none';
        }
      } catch (e) {
        statusEl.innerHTML = '<span style="color:#f87171">åŠ è½½å¤±è´¥</span>';
      }
    }
    
    async function saveWecomConfig(e) {
      e.preventDefault();
      
      const corpId = document.getElementById('wecomCorpId').value.trim();
      const agentId = document.getElementById('wecomAgentId').value.trim();
      const agentSecret = document.getElementById('wecomAgentSecret').value.trim();
      
      if (!corpId || !agentId || !agentSecret) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/api/wecom/configure`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: user.id, corpId, agentId, agentSecret })
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert('ä¼ä¸šå¾®ä¿¡é…ç½®æˆåŠŸï¼');
          loadWecomStatus();
        } else {
          alert('é…ç½®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (e) {
        alert('ç½‘ç»œé”™è¯¯: ' + e.message);
      }
    }
    
    function copyWecomWebhook() {
      const input = document.getElementById('wecomWebhookUrl');
      input.select();
      document.execCommand('copy');
      alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }
    
    // ===== ä¿®æ”¹å¯†ç  =====
    
    function showPasswordChange() {
      document.getElementById('userDropdown').classList.remove('show');
      document.getElementById('passwordForm').reset();
      document.getElementById('passwordModal').classList.add('show');
    }
    
    function closePasswordModal() {
      document.getElementById('passwordModal').classList.remove('show');
    }
    
    async function changePassword(e) {
      e.preventDefault();
      
      const currentPwd = document.getElementById('currentPassword').value;
      const newPwd = document.getElementById('newPassword').value;
      const confirmPwd = document.getElementById('confirmPassword').value;
      
      if (newPwd !== confirmPwd) {
        alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
        return;
      }
      
      if (newPwd.length < 6) {
        alert('æ–°å¯†ç è‡³å°‘6ä½');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/api/auth/update`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('lingxi_token')}`
          },
          body: JSON.stringify({ 
            currentPassword: currentPwd,
            password: newPwd 
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
          closePasswordModal();
        } else {
          alert('ä¿®æ”¹å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (e) {
        alert('ç½‘ç»œé”™è¯¯: ' + e.message);
      }
    }
    
    // æ›´æ–°å¯¼èˆªæ ç”¨æˆ·å
    function updateNavUserName() {
      const nameEl = document.getElementById('navUserName');
      if (nameEl && user?.nickname) {
        nameEl.textContent = user.nickname;
      }
    }
    
    // HTML è½¬ä¹‰
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br>');
    }
    
    // å¯åŠ¨
    init();
    updateNavUserName();
  </script>
</body>
</html>
