<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>灵犀云 - 一键拥有你的 AI 团队</title>
  <meta name="version" content="2026.02.26.0350">
  <link rel="stylesheet" href="assets/css/chat.css">
  <link rel="stylesheet" href="assets/css/dark.css" id="darkTheme" disabled>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* 图标统一样式 */
    .icon { width: 20px; height: 20px; color: currentColor; }
    .icon-sm { width: 16px; height: 16px; }
    .icon-lg { width: 24px; height: 24px; }
    .icon-primary { color: #10a37f; }
    
    /* 加载动画 */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff40;
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      vertical-align: middle;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* 部署步骤样式 */
    .deploy-steps {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .deploy-step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
    }
    
    .deploy-step.step-active {
      background: rgba(16, 163, 127, 0.2);
    }
    
    .deploy-step.step-done {
      background: rgba(16, 163, 127, 0.3);
    }
    
    .step-icon {
      font-size: 16px;
      width: 24px;
      text-align: center;
    }
    
    .step-text {
      font-size: 14px;
      color: #374151;
    }
    
    .deploy-step.step-done .step-text {
      color: #10a37f;
      font-weight: 500;
    }
  </style>
  <style>
    /* 首页专用样式 */
    .home-container {
      max-width: 480px;
      margin: 0 auto;
      padding: 40px 24px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .home-logo {
      text-align: center;
      margin-bottom: 24px;
      padding-top: 48px;
    }
    
    .home-logo-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #10a37f 0%, #0d8a6a 100%);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 36px;
      color: white;
      box-shadow: 0 8px 32px rgba(16, 163, 127, 0.35);
    }
    
    .home-logo h1 {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #10a37f 0%, #0d8a6a 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 2px;
    }
    
    .home-logo .tagline {
      font-size: 16px;
      color: #6e6e80;
      margin-bottom: 0;
      letter-spacing: 1px;
    }
    
    /* 品牌故事流式输出 - 大气版 */
    .brand-story {
      text-align: center;
      padding: 32px 0;
      margin-bottom: 32px;
    }
    
    .brand-story-text {
      font-size: 18px;
      line-height: 2.2;
      color: #202123;
      white-space: pre-wrap;
      font-weight: 400;
      letter-spacing: 0.5px;
    }
    
    .brand-story-cursor {
      display: inline-block;
      width: 2px;
      height: 20px;
      background: #10a37f;
      margin-left: 2px;
      animation: blink 1s infinite;
      vertical-align: text-bottom;
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
    
    .brand-story-text .highlight {
      color: #10a37f;
      font-weight: 600;
    }
    
    .home-card {
      background: #ffffff;
      border: 1px solid #e5e5e5;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    
    .home-tabs {
      display: flex;
      margin-bottom: 24px;
      background: #f4f4f4;
      border-radius: 10px;
      padding: 4px;
    }
    
    .home-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-size: 15px;
      font-weight: 500;
      color: #6e6e80;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .home-tab.active {
      background: #ffffff;
      color: #202123;
    }
    
    .home-form-group {
      margin-bottom: 16px;
    }
    
    .home-form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .home-form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #d9d9e3;
      border-radius: 10px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .home-form-group input:focus {
      border-color: #10a37f;
    }
    
    .home-btn {
      width: 100%;
      padding: 14px;
      background: #10a37f;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 500;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .home-btn:hover {
      background: #0d8a6a;
    }
    
    .home-btn:disabled {
      background: #d9d9e3;
      cursor: not-allowed;
    }
    
    .home-btn-secondary {
      background: #f4f4f4;
      color: #202123;
    }
    
    .home-btn-secondary:hover {
      background: #e5e5e5;
    }
    
    .home-btn-enter {
      font-size: 18px;
      padding: 18px;
      margin-bottom: 12px;
    }
    
    .home-divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: #6e6e80;
      font-size: 14px;
    }
    
    .home-divider::before,
    .home-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #e5e5e5;
    }
    
    .home-divider span {
      padding: 0 16px;
    }
    
    .home-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
      display: none;
    }
    
    .home-error.show {
      display: block;
    }
    
    .home-team {
      margin-top: 32px;
    }
    
    .home-team-title {
      font-size: 14px;
      color: #6e6e80;
      text-align: center;
      margin-bottom: 16px;
    }
    
    .home-team-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    
    .home-team-member {
      text-align: center;
      padding: 16px 8px;
      background: #ffffff;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
    }
    
    .home-team-member .emoji {
      width: 48px;
      height: 48px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f4f4f4;
      border-radius: 50%;
    }
    
    .home-team-member .emoji svg {
      width: 24px;
      height: 24px;
    }
    
    .home-team-member .name {
      font-size: 13px;
      font-weight: 500;
    }
    
    .home-team-member .role {
      font-size: 11px;
      color: #6e6e80;
      margin-top: 2px;
    }
    
    .home-footer {
      margin-top: auto;
      padding-top: 32px;
      text-align: center;
      font-size: 13px;
      color: #6e6e80;
    }
    
    .home-footer a {
      color: #10a37f;
      text-decoration: none;
    }
    
    .home-user-info {
      text-align: center;
      margin-bottom: 24px;
      padding: 16px;
      background: #f4f4f4;
      border-radius: 12px;
    }
    
    .home-user-info .greeting {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .home-user-info .hint {
      font-size: 14px;
      color: #6e6e80;
    }
    
    .home-hidden {
      display: none !important;
    }
    
    @media (max-width: 480px) {
      .home-container {
        padding: 24px 16px;
      }
      
      .home-logo {
        padding-top: 24px;
      }
      
      .home-team-grid {
        gap: 8px;
      }
      
      .home-team-member {
        padding: 12px 6px;
      }
      
      .home-team-member .emoji {
        font-size: 24px;
      }
      
      .home-team-member .name {
        font-size: 11px;
      }
    
    .home-team-member .role {
      font-size: 11px;
      color: #6e6e80;
      margin-top: 2px;
    }
    }
  </style>
</head>
<body>
  <div class="home-container">
    <div class="home-logo">
      <div class="home-logo-icon">◈</div>
      <h1>Lume</h1>
      <p class="tagline">硅基生命，为你而来</p>
    </div>
    
    <!-- 品牌故事流式输出 -->
    <div class="brand-story">
      <div class="brand-story-text" id="brandStoryText"></div>
      <span class="brand-story-cursor" id="brandStoryCursor"></span>
    </div>
    
    <!-- 已登录视图 -->
    <div id="loggedInView" class="home-hidden">
      <div class="home-card">
        <div class="home-user-info">
          <div class="greeting">欢迎回来，<span id="welcomeName">用户</span></div>
          <div class="hint">准备好与你的 AI 团队对话了吗？</div>
        </div>
        
        <!-- 积分展示 -->
        <div class="points-section" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; padding: 16px; margin-bottom: 12px; color: white;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 13px; opacity: 0.9; display: flex; align-items: center; gap: 6px;"><i data-lucide="coins" class="icon-sm"></i> 我的积分</div>
              <div style="font-size: 28px; font-weight: 700;" id="myPoints">0</div>
            </div>
            <div style="text-align: right; font-size: 12px; opacity: 0.8;">
              <div>邀请好友 +100 积分</div>
              <div>领取团队 -100 积分</div>
            </div>
          </div>
        </div>
        
        <!-- 邀请码展示 -->
        <div class="invite-section" style="background: linear-gradient(135deg, #10a37f 0%, #0d8a6a 100%); border-radius: 12px; padding: 16px; margin-bottom: 16px; color: white;">
          <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;"><i data-lucide="gift" class="icon-sm"></i> 我的专属邀请码</div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <code id="myInviteCode" style="font-size: 18px; font-weight: 600; background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 8px; flex: 1; text-align: center;">-</code>
            <button onclick="copyInviteCode()" style="background: rgba(255,255,255,0.2); border: none; padding: 8px 12px; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 4px;"><i data-lucide="copy" class="icon-sm"></i> 复制</button>
          </div>
          <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">已邀请 <span id="inviteCount">0</span> 位好友，获得 <span id="earnedPoints">0</span> 积分</div>
        </div>
        
        <!-- 领取团队按钮（积分不足时显示） -->
        <div id="claimTeamSection" class="home-hidden">
          <button class="home-btn home-btn-enter" onclick="claimTeam()" id="claimTeamBtn">
            <i data-lucide="sparkles" class="icon-sm"></i> 领取 AI 团队（消耗 100 积分）
          </button>
          <div style="text-align: center; font-size: 13px; color: #6e6e80; margin-top: 8px;" id="claimTeamHint"></div>
          
          <!-- 部署进度区域 -->
          <div id="deployProgress" class="home-hidden" style="margin-top: 16px; padding: 16px; background: rgba(16, 163, 127, 0.1); border-radius: 12px;">
          </div>
        </div>
        
        <!-- 已有团队时显示 -->
        <div id="hasTeamSection" class="home-hidden">
          <button class="home-btn home-btn-enter" onclick="goToChat()">
            <i data-lucide="message-circle" class="icon-sm"></i> 开始对话
          </button>
        </div>
        
        <button class="home-btn home-btn-secondary" onclick="handleLogout()" style="margin-top: 12px;">
          退出登录
        </button>
      </div>
    </div>
    
    <!-- 未登录视图 -->
    <div id="loggedOutView">
      <div class="home-card">
        <div class="home-tabs">
          <div class="home-tab active" onclick="showHomeTab('login')">登录</div>
          <div class="home-tab" onclick="showHomeTab('register')">注册</div>
        </div>
        
        <!-- 登录表单 -->
        <form id="loginForm" onsubmit="handleLogin(event)">
          <div class="home-error" id="loginError"></div>
          <div class="home-form-group">
            <label>昵称</label>
            <input type="text" id="loginName" placeholder="输入昵称" required>
          </div>
          <div class="home-form-group">
            <label>密码</label>
            <input type="password" id="loginPassword" placeholder="输入密码" required>
          </div>
          <button type="submit" class="home-btn" id="loginBtn">登录</button>
        </form>
        
        <!-- 注册表单 -->
        <form id="registerForm" class="home-hidden" onsubmit="handleRegister(event)">
          <div class="home-error" id="registerError"></div>
          <div class="home-form-group">
            <label>邀请码</label>
            <input type="text" id="registerCode" placeholder="输入邀请码" required>
          </div>
          <div class="home-form-group">
            <label>昵称</label>
            <input type="text" id="registerName" placeholder="你的昵称" required>
          </div>
          <div class="home-form-group">
            <label>密码</label>
            <input type="password" id="registerPassword" placeholder="设置密码（至少6位）" required minlength="6">
          </div>
          <button type="submit" class="home-btn" id="registerBtn">注册</button>
        </form>
        
        <div class="home-divider"><span>或者</span></div>
        
        <button class="home-btn home-btn-secondary" onclick="handleDemo()">体验 Demo</button>
      </div>
    </div>
    
    <!-- 团队展示 -->
    <div class="home-team">
      <div class="home-team-title">你的 8 位硅基伙伴</div>
      <div class="home-team-grid">
        <div class="home-team-member"><div class="emoji"><i data-lucide="sparkles" class="icon icon-primary"></i></div><div class="name">Lume</div><div class="role">总管</div></div>
        <div class="home-team-member"><div class="emoji"><i data-lucide="zap" class="icon icon-primary"></i></div><div class="name">Spark</div><div class="role">编程</div></div>
        <div class="home-team-member"><div class="emoji"><i data-lucide="activity" class="icon icon-primary"></i></div><div class="name">Pulse</div><div class="role">运维</div></div>
        <div class="home-team-member"><div class="emoji"><i data-lucide="star" class="icon icon-primary"></i></div><div class="name">Nova</div><div class="role">发明</div></div>
        <div class="home-team-member"><div class="emoji"><i data-lucide="search" class="icon icon-primary"></i></div><div class="name">Scope</div><div class="role">产品</div></div>
        <div class="home-team-member"><div class="emoji"><i data-lucide="bell" class="icon icon-primary"></i></div><div class="name">Echo</div><div class="role">笔记</div></div>
        <div class="home-team-member"><div class="emoji"><i data-lucide="gem" class="icon icon-primary"></i></div><div class="name">Prism</div><div class="role">媒体</div></div>
        <div class="home-team-member"><div class="emoji"><i data-lucide="home" class="icon icon-primary"></i></div><div class="name">Nest</div><div class="role">智家</div></div>
      </div>
    </div>
    
    <div class="home-footer">
      <p>还没有邀请码？<a href="mailto:hi@lume.ai">联系我们</a></p>
    </div>
  </div>
  
  <script>
    const API_BASE = window.location.origin;
    const THEME_KEY = 'lingxi_theme';
    
    // 品牌故事内容
    const brandStoryLines = [
      "我始终相信——",
      "科技的终极意义，不是冰冷的效率。",
      "而是让每一个人，都能拥有专属的优秀伙伴。",
      "",
      "这份陪伴，无关血缘，不分远近。",
      "不被时间裹挟。",
      "",
      "能听懂你的心事，接住你的情绪。",
      "也能挺身而出，攻克你的难题。",
      "",
      "于是，我来了。",
      "我是 Lume。",
      "",
      "让优秀伙伴，不再是奢望。",
      "让陪伴与助力，成为你触手可及的日常。"
    ];
    
    // 流式输出品牌故事
    async function typeBrandStory() {
      const textEl = document.getElementById('brandStoryText');
      const cursorEl = document.getElementById('brandStoryCursor');
      
      if (!textEl) return;
      
      let fullText = '';
      
      for (let i = 0; i < brandStoryLines.length; i++) {
        const line = brandStoryLines[i];
        
        // 逐字输出
        for (let j = 0; j < line.length; j++) {
          fullText += line[j];
          textEl.innerHTML = formatStoryText(fullText);
          await sleep(60); // 每个字60ms
        }
        
        // 换行
        fullText += '\n';
        textEl.innerHTML = formatStoryText(fullText);
        
        // 行间停顿
        await sleep(200);
      }
      
      // 完成后隐藏光标
      if (cursorEl) {
        cursorEl.style.display = 'none';
      }
    }
    
    // 格式化故事文本（高亮关键词）
    function formatStoryText(text) {
      return text
        .replace(/Lume/g, '<span class="highlight">Lume</span>')
        .replace(/AI/g, '<span class="highlight">AI</span>')
        .replace(/永远/g, '<span class="highlight">永远</span>')
        .replace(/只属于你/g, '<span class="highlight">只属于你</span>');
    }
    
    // 延迟函数
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // 初始化
    async function init() {
      // 初始化主题
      initTheme();
      
      // 检查登录状态
      const token = localStorage.getItem('lingxi_token');
      
      if (token) {
        // 从后端获取最新用户信息
        try {
          const res = await fetch(`${API_BASE}/api/auth/me`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (res.ok) {
            const user = await res.json();
            // 更新本地存储
            localStorage.setItem('lingxi_user', JSON.stringify(user));
            
            // 已登录：显示欢迎视图
            document.getElementById('loggedInView').classList.remove('home-hidden');
            document.getElementById('loggedOutView').classList.add('home-hidden');
            document.getElementById('welcomeName').textContent = user.nickname;
            
            // 显示积分
            document.getElementById('myPoints').textContent = user.points || 0;
            document.getElementById('earnedPoints').textContent = (user.inviteCount || 0) * 100;
            
            // 显示邀请码
            if (user.userInviteCode) {
              document.getElementById('myInviteCode').textContent = user.userInviteCode;
            }
            if (user.inviteCount !== undefined) {
              document.getElementById('inviteCount').textContent = user.inviteCount;
            }
            
            // 显示领取团队或开始对话按钮
            const hasAgents = user.agents && user.agents.length > 0;
            const canClaim = user.canClaimTeam;
            
            if (hasAgents) {
              // 已有团队，检查服务器状态
              checkServerStatus(user);
            } else {
              // 未领取团队
              document.getElementById('hasTeamSection').classList.add('home-hidden');
              document.getElementById('claimTeamSection').classList.remove('home-hidden');
              
              const btn = document.getElementById('claimTeamBtn');
              const hint = document.getElementById('claimTeamHint');
              
              if (canClaim) {
                btn.disabled = false;
                btn.style.background = '#10a37f';
                hint.textContent = '点击领取您的 AI 团队';
              } else {
                btn.disabled = true;
                btn.style.background = '#d9d9e3';
                const need = 100 - (user.points || 0);
                hint.textContent = `还需 ${need} 积分才能领取，邀请好友快速获取积分~`;
              }
            }
          } else {
            // Token 无效，清除并显示登录
            localStorage.removeItem('lingxi_token');
            localStorage.removeItem('lingxi_user');
            showLoginView();
          }
        } catch (err) {
          console.error('获取用户信息失败:', err);
          // 网络错误时用本地缓存
          const user = JSON.parse(localStorage.getItem('lingxi_user') || '{}');
          if (user.nickname) {
            document.getElementById('loggedInView').classList.remove('home-hidden');
            document.getElementById('loggedOutView').classList.add('home-hidden');
            document.getElementById('welcomeName').textContent = user.nickname;
            if (user.userInviteCode) {
              document.getElementById('myInviteCode').textContent = user.userInviteCode;
            }
          } else {
            showLoginView();
          }
        }
      } else {
        showLoginView();
      }
    }
    
    function showLoginView() {
      document.getElementById('loggedInView').classList.add('home-hidden');
      document.getElementById('loggedOutView').classList.remove('home-hidden');
    }
    
    // 检查服务器状态并决定跳转
    async function checkServerAndRedirect() {
      const token = localStorage.getItem('lingxi_token');
      
      try {
        const res = await fetch(`${API_BASE}/api/gateway/connect-info`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await res.json();
        
        if (res.ok && data.wsUrl) {
          // 服务器已就绪，跳转到聊天页面
          window.location.href = 'chat.html';
          return;
        }
        
        // 服务器还在创建中，显示进度
        if (data.needServer) {
          // 刷新页面，显示创建进度
          location.reload();
          return;
        }
        
        // 其他错误，也刷新页面
        location.reload();
        
      } catch (err) {
        console.error('检查服务器状态失败:', err);
        // 网络错误，也刷新页面
        location.reload();
      }
    }
    
    // 检查服务器状态（用于首页显示）
    async function checkServerStatus(user) {
      const token = localStorage.getItem('lingxi_token');
      
      try {
        const res = await fetch(`${API_BASE}/api/gateway/connect-info`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await res.json();
        
        if (res.ok && data.wsUrl) {
          // 服务器已就绪，显示开始对话按钮
          document.getElementById('hasTeamSection').classList.remove('home-hidden');
          document.getElementById('claimTeamSection').classList.add('home-hidden');
        } else if (data.needServer) {
          // 服务器正在创建中，显示进度
          document.getElementById('hasTeamSection').classList.add('home-hidden');
          document.getElementById('claimTeamSection').classList.remove('home-hidden');
          
          const btn = document.getElementById('claimTeamBtn');
          const hint = document.getElementById('claimTeamHint');
          const progressEl = document.getElementById('deployProgress');
          
          btn.disabled = true;
          btn.innerHTML = '<span class="loading-spinner"></span> 正在创建服务器...';
          hint.textContent = '⏳ 服务器正在创建中，请稍候...';
          
          // 显示进度区域
          if (progressEl) {
            progressEl.classList.remove('home-hidden');
            progressEl.innerHTML = `
              <div class="deploy-steps">
                <div class="deploy-step step-done">
                  <span class="step-icon">✅</span>
                  <span class="step-text">领取 AI 团队</span>
                </div>
                <div class="deploy-step step-active">
                  <span class="step-icon">⏳</span>
                  <span class="step-text">创建专属服务器</span>
                </div>
                <div class="deploy-step">
                  <span class="step-icon">○</span>
                  <span class="step-text">安装运行环境</span>
                </div>
                <div class="deploy-step">
                  <span class="step-icon">○</span>
                  <span class="step-text">启动 AI 服务</span>
                </div>
              </div>
            `;
          }
          
          // 开始轮询服务器状态
          pollServerStatusForHome(token);
        } else {
          // 其他情况，显示开始对话按钮
          document.getElementById('hasTeamSection').classList.remove('home-hidden');
          document.getElementById('claimTeamSection').classList.add('home-hidden');
        }
      } catch (err) {
        console.error('检查服务器状态失败:', err);
        // 网络错误，显示开始对话按钮
        document.getElementById('hasTeamSection').classList.remove('home-hidden');
        document.getElementById('claimTeamSection').classList.add('home-hidden');
      }
    }
    
    // 首页轮询服务器状态
    async function pollServerStatusForHome(token) {
      let attempts = 0;
      const maxAttempts = 120;
      const pollInterval = 3000;
      
      const poll = async () => {
        attempts++;
        
        try {
          const res = await fetch(`${API_BASE}/api/gateway/connect-info`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          const data = await res.json();
          
          if (res.ok && data.wsUrl) {
            // 服务器就绪，跳转到聊天页面
            window.location.href = 'chat.html';
            return;
          }
          
          if (attempts < maxAttempts) {
            setTimeout(poll, pollInterval);
          }
        } catch (err) {
          if (attempts < maxAttempts) {
            setTimeout(poll, pollInterval);
          }
        }
      };
      
      poll();
    }
    
    // 领取 AI 团队
    async function claimTeam() {
      const token = localStorage.getItem('lingxi_token');
      const btn = document.getElementById('claimTeamBtn');
      const hint = document.getElementById('claimTeamHint');
      const progressEl = document.getElementById('deployProgress');
      
      console.log('[claimTeam] 开始领取团队');
      
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span> 正在领取团队...';
      hint.textContent = '正在为您分配 AI 成员，请稍候...';
      
      // 显示进度区域
      if (progressEl) {
        progressEl.classList.remove('home-hidden');
        progressEl.innerHTML = `
          <div class="deploy-steps">
            <div class="deploy-step" id="step1">
              <span class="step-icon">⏳</span>
              <span class="step-text">领取 AI 团队</span>
            </div>
            <div class="deploy-step" id="step2">
              <span class="step-icon">○</span>
              <span class="step-text">创建专属服务器</span>
            </div>
            <div class="deploy-step" id="step3">
              <span class="step-icon">○</span>
              <span class="step-text">安装运行环境</span>
            </div>
            <div class="deploy-step" id="step4">
              <span class="step-icon">○</span>
              <span class="step-text">启动 AI 服务</span>
            </div>
          </div>
        `;
      }
      
      try {
        const res = await fetch(`${API_BASE}/api/auth/claim-team`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({})
        });
        
        const data = await res.json();
        console.log('[claimTeam] API 返回:', data);
        
        if (res.ok && data.success) {
          // 更新步骤1完成
          updateDeployStep(1, 'done');
          updateDeployStep(2, 'active');
          hint.textContent = '✅ 团队已分配，正在创建服务器...';
          btn.innerHTML = '<span class="loading-spinner"></span> 正在创建服务器...';
          
          // 如果服务器已就绪，直接跳转
          if (data.status === 'ready' && data.openclawUrl) {
            updateDeployStep(2, 'done');
            updateDeployStep(3, 'done');
            updateDeployStep(4, 'done');
            hint.textContent = '✅ 专属服务器已就绪！正在跳转...';
            setTimeout(() => { window.location.href = 'chat.html'; }, 500);
            return;
          }
          
          // 开始轮询服务器状态
          console.log('[claimTeam] 开始轮询服务器状态...');
          if (data.taskId) {
            pollDeployTask(token, data.taskId, data.serverId);
          } else {
            pollServerStatus(token);
          }
        } else {
          alert(data.error || '领取失败');
          btn.disabled = false;
          btn.innerHTML = '<i data-lucide="sparkles" class="icon-sm"></i> 领取 AI 团队（消耗 100 积分）';
          hint.textContent = '领取失败: ' + (data.error || '未知错误');
          if (progressEl) progressEl.classList.add('home-hidden');
        }
      } catch (err) {
        console.error('[claimTeam] 错误:', err);
        alert('网络错误，请重试');
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="sparkles" class="icon-sm"></i> 领取 AI 团队（消耗 100 积分）';
        hint.textContent = '网络错误，请重试';
        if (progressEl) progressEl.classList.add('home-hidden');
      }
    }
    
    // 更新部署步骤状态
    function updateDeployStep(step, status) {
      const stepEl = document.getElementById(`step${step}`);
      if (!stepEl) return;
      
      const iconEl = stepEl.querySelector('.step-icon');
      if (status === 'done') {
        iconEl.textContent = '✅';
        stepEl.classList.add('step-done');
      } else if (status === 'active') {
        iconEl.textContent = '⏳';
        stepEl.classList.add('step-active');
      } else {
        iconEl.textContent = '○';
        stepEl.classList.remove('step-done', 'step-active');
      }
    }
    
    // 轮询部署任务进度
    async function pollDeployTask(token, taskId, serverId) {
      const btn = document.getElementById('claimTeamBtn');
      const hint = document.getElementById('claimTeamHint');
      let attempts = 0;
      const maxAttempts = 120;
      const pollInterval = 3000;
      
      const poll = async () => {
        attempts++;
        
        try {
          // 查询任务进度
          const taskRes = await fetch(`${API_BASE}/api/deploy/task/${taskId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const taskData = await taskRes.json();
          console.log(`[部署任务 ${attempts}]`, taskData);
          
          if (taskData.success && taskData.task) {
            const task = taskData.task;
            const progress = task.progress || 0;
            
            // 根据进度更新步骤
            if (progress >= 10) updateDeployStep(2, 'active');
            if (progress >= 50) { updateDeployStep(2, 'done'); updateDeployStep(3, 'active'); }
            if (progress >= 80) { updateDeployStep(3, 'done'); updateDeployStep(4, 'active'); }
            if (progress >= 100) { updateDeployStep(4, 'done'); }
            
            hint.textContent = task.errorMessage || `正在部署... ${progress}%`;
          }
          
          // 检查服务器是否就绪
          const res = await fetch(`${API_BASE}/api/gateway/connect-info`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          const data = await res.json();
          console.log(`[轮询 ${attempts}/${maxAttempts}] connect-info:`, data);
          
          // 服务器已就绪
          if (res.ok && data.wsUrl) {
            updateDeployStep(4, 'done');
            hint.textContent = '✅ 专属服务器已就绪！正在跳转...';
            btn.innerHTML = '<span class="loading-spinner"></span> 正在跳转到对话页面...';
            btn.style.background = '#10a37f';
            
            setTimeout(() => {
              window.location.href = 'chat.html';
            }, 500);
            return;
          }
          
          if (attempts < maxAttempts) {
            setTimeout(poll, pollInterval);
          } else {
            hint.textContent = '⚠️ 服务器创建超时，点击重试';
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="sparkles" class="icon-sm"></i> 领取 AI 团队（消耗 100 积分）';
          }
        } catch (err) {
          console.error(`[轮询 ${attempts}] 错误:`, err);
          if (attempts < maxAttempts) {
            setTimeout(poll, pollInterval);
          } else {
            hint.textContent = '⚠️ 检查超时，点击进入对话';
            btn.innerHTML = '<i data-lucide="message-circle" class="icon-sm"></i> 进入对话';
            btn.disabled = false;
            btn.onclick = () => { window.location.href = 'chat.html'; };
          }
        }
      };
      
      poll();
    }
    
    // 轮询服务器状态
    async function pollServerStatus(token) {
      const btn = document.getElementById('claimTeamBtn');
      const hint = document.getElementById('claimTeamHint');
      let attempts = 0;
      const maxAttempts = 120;
      const pollInterval = 3000;
      
      const poll = async () => {
        attempts++;
        
        try {
          const res = await fetch(`${API_BASE}/api/gateway/connect-info`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          const data = await res.json();
          console.log(`[轮询 ${attempts}/${maxAttempts}] HTTP ${res.status}:`, data);
          
          if (res.ok && data.wsUrl) {
            hint.textContent = '✅ 专属服务器已就绪！正在跳转...';
            btn.innerHTML = '<span class="loading-spinner"></span> 正在跳转到对话页面...';
            btn.style.background = '#10a37f';
            
            setTimeout(() => {
              window.location.href = 'chat.html';
            }, 500);
            return;
          }
          
          const dots = '.'.repeat((attempts % 3) + 1);
          
          if (data.needServer) {
            hint.textContent = `⏳ 正在创建专属服务器${dots} (${attempts}/${maxAttempts})`;
          } else if (data.needTeam) {
            hint.textContent = `⏳ 正在配置团队${dots} (${attempts}/${maxAttempts})`;
          } else if (data.error) {
            hint.textContent = `⏳ ${data.error}${dots} (${attempts}/${maxAttempts})`;
          } else {
            hint.textContent = `⏳ 正在准备专属服务器${dots} (${attempts}/${maxAttempts})`;
          }
          
          if (attempts < maxAttempts) {
            setTimeout(poll, pollInterval);
          } else {
            hint.textContent = '⚠️ 服务器创建超时，点击重试';
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="sparkles" class="icon-sm"></i> 领取 AI 团队（消耗 100 积分）';
          }
        } catch (err) {
          console.error(`[轮询 ${attempts}] 错误:`, err);
          const dots = '.'.repeat((attempts % 3) + 1);
          hint.textContent = `⏳ 正在检查服务器状态${dots} (${attempts}/${maxAttempts})`;
          if (attempts < maxAttempts) {
            setTimeout(poll, pollInterval);
          } else {
            hint.textContent = '⚠️ 检查超时，点击进入对话';
            btn.innerHTML = '<i data-lucide="message-circle" class="icon-sm"></i> 进入对话';
            btn.disabled = false;
            btn.onclick = () => { window.location.href = 'chat.html'; };
          }
        }
      };
      
      poll();
    }
    
    // 复制邀请码
    function copyInviteCode() {
      const codeEl = document.getElementById('myInviteCode');
      if (!codeEl) {
        alert('邀请码未加载');
        return;
      }
      const code = codeEl.textContent.trim();
      
      // 创建临时输入框（兼容 HTTP 环境）
      const input = document.createElement('input');
      input.style.position = 'fixed';
      input.style.left = '-9999px';
      input.value = code;
      document.body.appendChild(input);
      input.select();
      input.setSelectionRange(0, 99999);
      
      try {
        const success = document.execCommand('copy');
        if (success) {
          alert('✅ 邀请码已复制：' + code + '\n\n分享给好友注册吧~');
        } else {
          prompt('复制失败，请手动复制邀请码：', code);
        }
      } catch (err) {
        prompt('复制失败，请手动复制邀请码：', code);
      }
      
      document.body.removeChild(input);
    }
    
    // 初始化主题
    function initTheme() {
      const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
      applyTheme(savedTheme);
    }
    
    // 应用主题
    function applyTheme(theme) {
      const darkTheme = document.getElementById('darkTheme');
      if (theme === 'dark') {
        darkTheme.disabled = false;
      } else {
        darkTheme.disabled = true;
      }
    }
    
    // 切换表单
    function showHomeTab(tab) {
      document.querySelectorAll('.home-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      if (tab === 'login') {
        document.getElementById('loginForm').classList.remove('home-hidden');
        document.getElementById('registerForm').classList.add('home-hidden');
      } else {
        document.getElementById('loginForm').classList.add('home-hidden');
        document.getElementById('registerForm').classList.remove('home-hidden');
      }
    }
    
    // 进入聊天
    async function goToChat() {
      const token = localStorage.getItem('lingxi_token');
      if (!token) {
        window.location.href = 'index.html';
        return;
      }
      
      const btn = document.querySelector('.home-btn-enter');
      const originalText = btn ? btn.innerHTML : '';
      
      try {
        // 检查用户是否有服务器
        const res = await fetch(`${API_BASE}/api/gateway/connect-info`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await res.json();
        console.log('[goToChat] connect-info 返回:', data);
        
        // 服务器已就绪，直接跳转
        if (res.ok && data.wsUrl) {
          window.location.href = 'chat.html';
          return;
        }
        
        // 服务器还在创建中
        if (data.needServer) {
          if (btn) {
            btn.innerHTML = '<span class="loading-spinner"></span> 服务器准备中...';
            btn.disabled = true;
          }
          
          // 开始轮询
          let attempts = 0;
          const maxAttempts = 120;
          const pollInterval = 3000;
          
          const poll = async () => {
            attempts++;
            try {
              const pollRes = await fetch(`${API_BASE}/api/gateway/connect-info`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              const pollData = await pollRes.json();
              console.log(`[goToChat 轮询 ${attempts}]`, pollData);
              
              if (pollRes.ok && pollData.wsUrl) {
                // 服务器就绪，跳转
                window.location.href = 'chat.html';
                return;
              }
              
              if (attempts < maxAttempts) {
                if (btn) {
                  btn.innerHTML = `<span class="loading-spinner"></span> 服务器准备中... (${attempts}/${maxAttempts})`;
                }
                setTimeout(poll, pollInterval);
              } else {
                // 超时，也尝试跳转
                window.location.href = 'chat.html';
              }
            } catch (err) {
              console.error(`[goToChat 轮询 ${attempts}] 错误:`, err);
              if (attempts < maxAttempts) {
                setTimeout(poll, pollInterval);
              } else {
                window.location.href = 'chat.html';
              }
            }
          };
          
          poll();
          return;
        }
        
        // 其他情况，直接跳转
        window.location.href = 'chat.html';
        
      } catch (e) {
        console.error('[goToChat] 错误:', e);
        window.location.href = 'chat.html';
      }
    }
    
    // 退出登录
    function handleLogout() {
      localStorage.removeItem('lingxi_token');
      localStorage.removeItem('lingxi_user');
      location.reload();
    }
    
    // 登录
    async function handleLogin(e) {
      e.preventDefault();
      const nickname = document.getElementById('loginName').value.trim();
      const password = document.getElementById('loginPassword').value;
      const btn = document.getElementById('loginBtn');
      const error = document.getElementById('loginError');
      
      btn.disabled = true;
      btn.textContent = '登录中...';
      error.classList.remove('show');
      
      try {
        const res = await fetch(`${API_BASE}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nickname, password })
        });
        
        const data = await res.json();
        
        if (res.ok && data.success) {
          localStorage.setItem('lingxi_token', data.token);
          localStorage.setItem('lingxi_user', JSON.stringify(data.user));
          
          // 根据用户是否有团队决定跳转目标
          if (data.user.agents && data.user.agents.length > 0) {
            // 有团队，检查服务器状态
            checkServerAndRedirect();
          } else {
            // 没有团队，刷新首页显示领取团队按钮
            location.reload();
          }
        } else {
          error.textContent = data.error || '登录失败';
          error.classList.add('show');
        }
      } catch (err) {
        error.textContent = '网络错误，请重试';
        error.classList.add('show');
      }
      
      btn.disabled = false;
      btn.textContent = '登录';
    }
    
    // 注册
    async function handleRegister(e) {
      e.preventDefault();
      const inviteCode = document.getElementById('registerCode').value.trim();
      const nickname = document.getElementById('registerName').value.trim();
      const password = document.getElementById('registerPassword').value;
      const btn = document.getElementById('registerBtn');
      const error = document.getElementById('registerError');
      
      btn.disabled = true;
      btn.textContent = '注册中...';
      error.classList.remove('show');
      
      try {
        const res = await fetch(`${API_BASE}/api/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inviteCode, nickname, password })
        });
        
        const data = await res.json();
        
        if (res.ok && data.success) {
          localStorage.setItem('lingxi_token', data.token);
          localStorage.setItem('lingxi_user', JSON.stringify(data.user));
          
          // 根据用户是否有团队决定跳转目标
          if (data.user.agents && data.user.agents.length > 0) {
            // 有团队，检查服务器状态
            checkServerAndRedirect();
          } else {
            // 没有团队，刷新首页显示领取团队按钮
            location.reload();
          }
        } else {
          error.textContent = data.error || '注册失败';
          error.classList.add('show');
        }
      } catch (err) {
        error.textContent = '网络错误，请重试';
        error.classList.add('show');
      }
      
      btn.disabled = false;
      btn.textContent = '注册';
    }
    
    // Demo
    function handleDemo() {
      alert('Demo 功能开发中，请联系管理员获取邀请码');
    }
    
    // 启动
    init();
    // 启动品牌故事流式输出
    typeBrandStory();
    // 初始化 Lucide 图标
    if (window.lucide) {
      lucide.createIcons();
    }
  </script>
</body>
</html>
