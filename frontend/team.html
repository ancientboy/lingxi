<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€‰æ‹©ä½ çš„å›¢é˜Ÿ - çµçŠ€äº‘</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0f;
      min-height: 100vh;
      color: #fff;
      padding: 40px 20px;
    }
    .container { max-width: 800px; margin: 0 auto; text-align: center; }
    .logo {
      font-size: 48px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #00d4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .subtitle { color: rgba(255,255,255,0.6); margin-bottom: 40px; }
    .agents-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 40px;
    }
    .agent-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 20px 15px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .agent-card:hover {
      background: rgba(255,255,255,0.08);
      transform: translateY(-3px);
    }
    .agent-card.selected {
      background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(0,212,255,0.1));
      border-color: rgba(102,126,234,0.5);
      box-shadow: 0 5px 20px rgba(102,126,234,0.3);
    }
    .agent-card.disabled { opacity: 0.5; cursor: not-allowed; }
    .agent-emoji { font-size: 36px; margin-bottom: 8px; }
    .agent-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .agent-desc { font-size: 12px; color: rgba(255,255,255,0.5); }
    .submit-btn {
      padding: 16px 60px;
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .submit-btn:hover { transform: scale(1.02); }
    .submit-btn:disabled { background: #333; cursor: not-allowed; }
    @media (max-width: 768px) {
      .agents-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">âš¡ çµçŠ€äº‘</div>
    <p class="subtitle">é€‰æ‹©ä½ éœ€è¦çš„å›¢é˜Ÿæˆå‘˜</p>
    
    <div class="agents-grid" id="agentsGrid"></div>
    
    <button class="submit-btn" id="submitBtn" onclick="submitTeam()">
      ğŸš€ ç¡®è®¤å¹¶å¼€å§‹ä½¿ç”¨
    </button>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000';
    
    const agents = [
      { id: 'lingxi', emoji: 'âš¡', name: 'çµçŠ€', desc: 'é˜Ÿé•¿', required: true },
      { id: 'coder', emoji: 'ğŸ’»', name: 'äº‘æºª', desc: 'ä»£ç å¥³ç‹' },
      { id: 'ops', emoji: 'ğŸ“Š', name: 'è‹¥æ›¦', desc: 'è¿è¥ä¸“å®¶' },
      { id: 'inventor', emoji: 'ğŸ’¡', name: 'ç´«è±', desc: 'åˆ›æ„å¤©æ‰' },
      { id: 'pm', emoji: 'ğŸ¯', name: 'æ¢“è±', desc: 'äº§å“å¥³ç‹' },
      { id: 'noter', emoji: 'ğŸ“', name: 'æ™“ç³', desc: 'çŸ¥è¯†ç®¡ç†' },
      { id: 'media', emoji: 'ğŸ§', name: 'éŸ³éŸµ', desc: 'å¤šåª’ä½“' },
      { id: 'smart', emoji: 'ğŸ ', name: 'æ™ºå®¶', desc: 'æ™ºèƒ½å®¶å±…' }
    ];

    let selectedAgents = ['lingxi'];
    const token = localStorage.getItem('lingxi_token');

    // æ£€æŸ¥ç™»å½•
    if (!token) {
      window.location.href = 'index.html';
    }

    // æ¸²æŸ“ Agent å¡ç‰‡
    function renderAgents() {
      const grid = document.getElementById('agentsGrid');
      grid.innerHTML = agents.map(agent => `
        <div class="agent-card ${agent.required ? 'selected disabled' : ''}" 
             id="agent-${agent.id}"
             onclick="${agent.required ? '' : `toggleAgent('${agent.id}')`}">
          <div class="agent-emoji">${agent.emoji}</div>
          <div class="agent-name">${agent.name}</div>
          <div class="agent-desc">${agent.desc}</div>
        </div>
      `).join('');
    }

    // åˆ‡æ¢é€‰æ‹©
    function toggleAgent(id) {
      const card = document.getElementById(`agent-${id}`);
      if (selectedAgents.includes(id)) {
        selectedAgents = selectedAgents.filter(a => a !== id);
        card.classList.remove('selected');
      } else {
        selectedAgents.push(id);
        card.classList.add('selected');
      }
    }

    // æäº¤å›¢é˜Ÿé…ç½®
    async function submitTeam() {
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'â³ é…ç½®ä¸­...';
      
      try {
        // è·å–ç”¨æˆ·ä¿¡æ¯
        const userStr = localStorage.getItem('lingxi_user');
        const user = userStr ? JSON.parse(userStr) : null;
        const userId = user?.id;
        
        if (!userId) {
          alert('ç™»å½•çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
          window.location.href = 'index.html';
          return;
        }
        
        // è°ƒç”¨åç«¯é…ç½®å›¢é˜Ÿ
        const res = await fetch(`${API_BASE}/api/instance/assign`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ userId, agents: selectedAgents })
        });
        
        const data = await res.json();
        
        if (data.success) {
          // ä¿å­˜å›¢é˜Ÿé…ç½®åˆ°æœ¬åœ°
          user.agents = selectedAgents;
          localStorage.setItem('lingxi_user', JSON.stringify(user));
          
          // è·³è½¬åˆ°èŠå¤©é¡µé¢
          window.location.href = 'chat.html';
        } else {
          alert(data.error || 'é…ç½®å¤±è´¥');
        }
      } catch (e) {
        alert('ç½‘ç»œé”™è¯¯ï¼š' + e.message);
      }
      
      btn.disabled = false;
      btn.textContent = 'ğŸš€ ç¡®è®¤å¹¶å¼€å§‹ä½¿ç”¨';
    }

    // åˆå§‹åŒ–
    renderAgents();
  </script>
</body>
</html>
